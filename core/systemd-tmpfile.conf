# SPDX-FileCopyrightText: 2025 Zextras <https://www.zextras.com>
# SPDX-License-Identifier: GPL-2.0-only

# Carbonio Core directories and permissions
# See tmpfiles.d(5) for format
#
# WARNING: DO NOT add recursive operations (Z) for large data directories:
# /opt/zextras/store, /opt/zextras/backup, /opt/zextras/index, /opt/zextras/redolog (IN-898)
#
# Note: setcap CAP_NET_BIND_SERVICE on slapd must be handled in postinst

# Base runtime directories
d /run/carbonio 0755 zextras zextras
d /run/carbonio/run 0755 zextras zextras
d /run/carbonio/stats 0755 zextras zextras

# Core application directories
d /opt/zextras/.ssh 0700 zextras zextras
d /opt/zextras/common/ca 0755 zextras zextras
d /opt/zextras/common/conf 0775 root zextras
d /opt/zextras/contrib 0755 root root
d /opt/zextras/data 0775 root zextras
d /opt/zextras/data/tmp 1777 zextras zextras
d /opt/zextras/db 0755 zextras zextras
d /opt/zextras/db/data 0755 zextras zextras
d /opt/zextras/fbqueue 0755 zextras zextras
d /opt/zextras/log 0755 zextras zextras
d /opt/zextras/ssl 0755 zextras zextras
d /opt/zextras/zmstat 0755 zextras zextras

# Data storage directories (non-recursive ownership for performance - IN-898)
d /opt/zextras/backup 0755 zextras zextras
d /opt/zextras/index 0755 zextras zextras
d /opt/zextras/redolog 0755 zextras zextras
d /opt/zextras/store 0755 zextras zextras

# User dotfiles and history files
f /opt/zextras/.bash_history 0640 zextras zextras
f /opt/zextras/.zmprov_history 0640 zextras zextras
f /opt/zextras/.zmmailbox_history 0640 zextras zextras

# System log file
f /var/log/carbonio.log 0640 syslog adm

# Adjust ownership and permissions on existing files/directories (non-recursive)
z /etc/init.d/carbonio 0755 - -
z /etc/sudoers.d/carbonio 0440 root root
z /opt/zextras 0755 root root
z /opt/zextras/.bash_profile - zextras zextras
z /opt/zextras/.bashrc - zextras zextras
z /opt/zextras/.exrc - zextras zextras
z /opt/zextras/.ldaprc - zextras zextras
z /opt/zextras/.platform - zextras zextras
z /opt/zextras/.viminfo - zextras zextras
z /opt/zextras/bin/* 0755 root root
z /opt/zextras/conf/ca 0755 zextras zextras
z /opt/zextras/conf/ca/* 0644 zextras zextras
z /opt/zextras/conf/localconfig 0640 zextras zextras
z /opt/zextras/conf/my.cnf 0640 zextras zextras
z /opt/zextras/conf/saslauthd.conf 0440 zextras zextras
z /opt/zextras/conf/saslauthd.conf.in 0640 zextras zextras
z /opt/zextras/conf/sasl2/smtpd.conf 0640 zextras zextras
z /opt/zextras/conf/sasl2/smtpd.conf.in 0640 zextras zextras
z /opt/zextras/conf/*.crt 0640 zextras zextras
z /opt/zextras/conf/*.key 0640 zextras zextras
z /opt/zextras/conf/zmssl.cnf 0640 zextras zextras
z /opt/zextras/contrib/* 0755 root root
z /opt/zextras/data/systemd.env - zextras zextras
z /opt/zextras/data/tmp/current.csr 0644 zextras zextras
z /opt/zextras/lib/lib*so* 0755 root root
z /opt/zextras/libexec/* 0755 root root
z /opt/zextras/log - zextras zextras
f /opt/zextras/log/.hotspot_compiler 0444 root root
# SSL files - specific globs to avoid matching directories (directories created by zmcertmgr)
z /opt/zextras/ssl/carbonio/*.key 0640 zextras zextras
z /opt/zextras/ssl/carbonio/*.crt 0640 zextras zextras
z /opt/zextras/ssl/carbonio/*.pem 0640 zextras zextras
z /opt/zextras/ssl/carbonio/ca/*.key 0600 zextras zextras
z /opt/zextras/ssl/carbonio/ca/*.pem 0640 zextras zextras
z /opt/zextras/ssl/carbonio/server/*.key 0640 zextras zextras
z /opt/zextras/ssl/carbonio/server/*.crt 0640 zextras zextras
z /opt/zextras/ssl/carbonio/commercial/*.key 0640 zextras zextras
z /opt/zextras/ssl/carbonio/commercial/*.crt 0640 zextras zextras

# Recursive ownership and permissions (use sparingly for performance)
# Note: Lines marked with ~mode use smart masking - execute bits are preserved
# only if the file already has them (directories=755, text files=644)
Z /opt/zextras/admin - zextras zextras
Z /opt/zextras/bin - root root
# /opt/zextras/common subdirectories - explicit list to avoid clearing setcap on binaries
# Note: sbin and libexec are handled separately (non-recursive) to preserve capabilities
z /opt/zextras/common 0755 root root
Z /opt/zextras/common/bin 0755 root root
Z /opt/zextras/common/ca - zextras zextras
Z /opt/zextras/common/certbot 0755 root root
Z /opt/zextras/common/conf 0775 root zextras
Z /opt/zextras/common/etc 0755 root root
Z /opt/zextras/common/include 0755 root root
Z /opt/zextras/common/lib 0755 root root
Z /opt/zextras/common/lib/jylibs - root root
Z /opt/zextras/common/lib/perl5/Zextras 0755 root root
Z /opt/zextras/common/lib64 0755 root root
Z /opt/zextras/common/man 0755 root root
Z /opt/zextras/common/share 0755 root root
# sbin and libexec: non-recursive to preserve setcap on nginx and slapd binaries
z /opt/zextras/common/sbin 0755 root root
z /opt/zextras/common/libexec 0755 root root
Z /opt/zextras/conf - zextras zextras
Z /opt/zextras/conf/crontabs - root root
Z /opt/zextras/conf/spamassassin 0755 zextras zextras
Z /opt/zextras/contrib - root root
Z /opt/zextras/data/tmp 1777 zextras zextras
Z /opt/zextras/documentation 0755 zextras zextras
Z /opt/zextras/jython - zextras zextras
Z /opt/zextras/lib - root root
Z /opt/zextras/lib/ext - root root
Z /opt/zextras/lib/ext-common - root root
Z /opt/zextras/libexec - root root
Z /opt/zextras/ssl - zextras zextras
Z /opt/zextras/web - zextras zextras
Z /opt/zextras/zal - zextras zextras
Z /opt/zextras/zmstat - zextras zextras
