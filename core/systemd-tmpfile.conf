# WARNING: DO NOT add recursive operations (Z) for the following directories
# as they can contain large amounts of data and cause performance issues (IN-898):
# - /opt/zextras/store (user mailboxes)
# - /opt/zextras/backup (backup data)
# - /opt/zextras/index (search indexes)
# - /opt/zextras/redolog (transaction logs)
# These directories should only have their top-level ownership set (already done with 'z' above)

# Note: The following operations require RPM post-install script and cannot be handled by tmpfiles.d:
# 1. setcap CAP_NET_BIND_SERVICE=+ep /opt/zextras/common/libexec/slapd
# 2. Documentation files read-only (zmfixperms sets files=444, but tmpfiles.d ~mode cannot
#    achieve this without breaking directory traversal. Accepting files=755 is cosmetic only.)

# Base runtime directories
d /run/carbonio 0755 zextras zextras
d /run/carbonio/run 0755 zextras zextras
d /run/carbonio/stats 0755 zextras zextras

# Core application directories
d /opt/zextras/.ssh 0700 zextras zextras
d /opt/zextras/common/ca 0755 zextras zextras
d /opt/zextras/common/conf 0775 root zextras
d /opt/zextras/contrib 0755 root root
d /opt/zextras/data 0755 root zextras
d /opt/zextras/data/tmp 1777 zextras zextras
d /opt/zextras/db 0755 zextras zextras
d /opt/zextras/db/data 0755 zextras zextras
d /opt/zextras/fbqueue 0755 zextras zextras
d /opt/zextras/log 0755 zextras zextras
d /opt/zextras/ssl 0755 zextras zextras
d /opt/zextras/zmstat 0755 zextras zextras

# Data storage directories (non-recursive ownership for performance - IN-898)
d /opt/zextras/backup 0755 zextras zextras
d /opt/zextras/index 0755 zextras zextras
d /opt/zextras/redolog 0755 zextras zextras
d /opt/zextras/store 0755 zextras zextras

# User dotfiles and history files
f /opt/zextras/.bash_history 0640 zextras zextras
f /opt/zextras/.zmprov_history 0640 zextras zextras
f /opt/zextras/.zmmailbox_history 0640 zextras zextras

# System log file
f /var/log/carbonio.log 0640 syslog adm

# Adjust ownership and permissions on existing files/directories (non-recursive)
z /etc/init.d/carbonio 0755 - -
z /etc/sudoers.d/carbonio 0440 root root
z /opt/zextras 0755 root root
z /opt/zextras/.bash_profile - zextras zextras
z /opt/zextras/.bashrc - zextras zextras
z /opt/zextras/.exrc - zextras zextras
z /opt/zextras/.ldaprc - zextras zextras
z /opt/zextras/.platform - zextras zextras
z /opt/zextras/.viminfo - zextras zextras
z /opt/zextras/bin/* 0755 root root
z /opt/zextras/conf/ca 0755 zextras zextras
z /opt/zextras/conf/ca/* 0644 zextras zextras
z /opt/zextras/conf/localconfig 0640 zextras zextras
z /opt/zextras/conf/my.cnf 0640 zextras zextras
z /opt/zextras/conf/saslauthd.conf 0440 zextras zextras
z /opt/zextras/conf/saslauthd.conf.in 0640 zextras zextras
z /opt/zextras/conf/sasl2/smtpd.conf 0640 zextras zextras
z /opt/zextras/conf/sasl2/smtpd.conf.in 0640 zextras zextras
z /opt/zextras/conf/*.crt 0640 zextras zextras
z /opt/zextras/conf/*.key 0640 zextras zextras
z /opt/zextras/conf/zmssl.cnf 0640 zextras zextras
z /opt/zextras/contrib/* 0755 root root
z /opt/zextras/data/systemd.env - zextras zextras
z /opt/zextras/data/tmp/current.csr 0644 zextras zextras
z /opt/zextras/lib/lib*so* 0755 root root
z /opt/zextras/libexec/* 0755 root root
z /opt/zextras/log - zextras zextras
f /opt/zextras/log/.hotspot_compiler 0444 root root - -
z /opt/zextras/ssl/carbonio 0750 zextras zextras
z /opt/zextras/ssl/* 0640 zextras zextras

# Recursive ownership and permissions (use sparingly for performance)
# Note: Lines marked with ~mode use smart masking - execute bits are preserved
# only if the file already has them (directories=755, text files=644)
Z /opt/zextras/admin - zextras zextras
Z /opt/zextras/bin - root root
Z /opt/zextras/common 0755 root root
Z /opt/zextras/common/ca - zextras zextras
Z /opt/zextras/common/conf 0775 root zextras
Z /opt/zextras/common/lib/jylibs - root root
Z /opt/zextras/common/lib/perl5/Zextras 0755 root root
Z /opt/zextras/conf - zextras zextras
Z /opt/zextras/conf/crontabs - root root
Z /opt/zextras/conf/spamassassin 0755 zextras zextras
Z /opt/zextras/contrib - root root
Z /opt/zextras/data/tmp 1777 zextras zextras
Z /opt/zextras/documentation 0755 zextras zextras
Z /opt/zextras/jython - zextras zextras
Z /opt/zextras/lib - root root
Z /opt/zextras/lib/ext - root root
Z /opt/zextras/lib/ext-common - root root
Z /opt/zextras/libexec - root root
Z /opt/zextras/ssl - zextras zextras
Z /opt/zextras/web - zextras zextras
Z /opt/zextras/zal - zextras zextras
Z /opt/zextras/zmstat - zextras zextras
