pkgname="carbonio-core"
pkgver="4.2.1"
pkgrel="1"
pkgdesc="Core components and resources for Carbonio"
maintainer="Zextras <packages@zextras.com>"
copyright=(
  "2022-2024, Zextras <https://www.zextras.com>"
  "2022, Synacor, Inc."
)
license=(
  "GPL-2.0-only"
)
url="https://github.com/zextras"
section="mail"
priority="optional"
arch=('x86_64')
depends__apt=(
  "adduser"
  "carbonio-common-appserver-conf"
  "carbonio-common-appserver-native-lib"
  "carbonio-common-core-jar"
  "carbonio-common-core-libs"
  "carbonio-innotop"
  "carbonio-openjdk-cacerts"
  "carbonio-openjdk"
  "carbonio-openldap"
  "carbonio-openssl"
  "carbonio-perl-carp-clan"
  "carbonio-perl-crypt-saltedhash"
  "carbonio-perl-data-uuid"
  "carbonio-perl-date-manip"
  "carbonio-perl-dbi"
  "carbonio-perl-file-grep"
  "carbonio-perl-filesys-df"
  "carbonio-perl-io-compress"
  "carbonio-perl-json-pp"
  "carbonio-perl-net-dns"
  "carbonio-perl-net-ldap"
  "carbonio-perl-netaddr-ip"
  "carbonio-perl-xml-simple"
  "carbonio-prometheus-node-exporter"
  "carbonio-timezone-data"
  "coreutils"
  "file"
  "fontconfig"
  "iproute2"
  "libaio1"
  "libexpat1"
  "libgmp10"
  "libpcre3"
  "perl"
  "libsocket6-perl"
  "libstdc++6"
  "lsb-release"
  "net-tools"
  "netcat-openbsd"
  "openssh-client"
  "passwd"
  "pax"
  "pending-setups"
  "perl"
  "procps"
  "resolvconf"
  "rsyslog"
  "service-discover"
  "sudo"
  "sysstat"
  "unzip"
)
depends__yum=(
  "carbonio-common-appserver-conf"
  "carbonio-common-appserver-native-lib"
  "carbonio-common-core-jar"
  "carbonio-common-core-libs"
  "carbonio-innotop"
  "carbonio-openjdk-cacerts"
  "carbonio-openjdk"
  "carbonio-openldap"
  "carbonio-openssl"
  "carbonio-perl-carp-clan"
  "carbonio-perl-crypt-saltedhash"
  "carbonio-perl-data-uuid"
  "carbonio-perl-date-manip"
  "carbonio-perl-dbi"
  "carbonio-perl-file-grep"
  "carbonio-perl-filesys-df"
  "carbonio-perl-io-compress"
  "carbonio-perl-json-pp"
  "carbonio-perl-net-dns"
  "carbonio-perl-net-ldap"
  "carbonio-perl-netaddr-ip"
  "carbonio-perl-xml-simple"
  "carbonio-prometheus-node-exporter"
  "carbonio-timezone-data"
  "coreutils"
  "expat"
  "file"
  "fontconfig"
  "gmp"
  "iproute"
  "libaio"
  "libstdc++"
  "net-tools"
  "netcat"
  "openssh"
  "pcre"
  "pending-setups"
  "perl-core"
  "perl-Socket6"
  "perl"
  "rsyslog"
  "service-discover"
  "shadow-utils"
  "sudo"
  "sysstat"
  "unzip"
)
provides__yum=(
  "/usr/bin/zmpython"
)
optdepends=(
  "carbonio-common-appserver-docs"
)
source=(
  "carbonio-amavis::git+${url}/carbonio-amavis#tag=4.0.7"
  "carbonio-core-utils::git+${url}/carbonio-core-utils#tag=4.0.35"
  "carbonio-freshclam::git+${url}/carbonio-freshclam#tag=4.0.3"
  "carbonio-jython::git+${url}/carbonio-jython#tag=4.0.4"
  "https://zextras.jfrog.io/artifactory/public-maven-repo/zimbra/zm-certificate-manager-store/23.2.0/zm-certificate-manager-store-23.2.0.jar"
  "https://repo1.maven.org/maven2/com/kohlschutter/junixsocket/junixsocket-native/2.4.0/junixsocket-native-2.4.0.nar"
  "10-carbonio.conf"
  "carbonio-bootstrap"
  "carbonio-configd.service"
  "carbonio-stats.service"
  "carbonio-tmpfile.conf"
  "mini_alue_ce"
)
sha256sums=(
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  "d9628f2126a5cf2b05c0b87945bb60a2f95fb1acfc8401a519f49ebced89fdf8"
  "6a01e0a69be5469284326fcecb19425d3605aea5777c7a4500bedabbfec78a97"
  "54c6ebe00b43c80246a95a29252be11b04207cb21d1d64f324b4ad3f72eec711"
  "61f59f9ff7f1e43e4623e9f595fcef633e525e33796ebf716e6d9e834a9e1484"
  "6a73c0f3b37ae7a4c3b2ab1fbf58e8767127148ab625df3884c7bcc66b8a0c07"
  "d10ca641e5cfb01c5ce72e7cf17fb440d97ef440423cfe15788d67575ba31ede"
  "c259063d1823a9b301195f091d98b646b9bf720270f105489c352493b45c42e0"
  "544194a67e761eca7f9873551f6f3c81853cf8610a46cc100568211e2a2a0d9c"
)

package() {

  # LOCAL FILES

  # srcdir is /tmp/core/src, yap creates src with sources but cannot move nested directories, only flat files
  cd "${srcdir}/.."
  install -Dm640 10-carbonio.conf \
    "${pkgdir}/etc/security/limits.d/10-carbonio.conf"
  install -Dm755 carbonio-bootstrap \
    "${pkgdir}/usr/bin/carbonio-bootstrap"
  install -Dm755 mini_alue_ce \
    "${pkgdir}"/opt/zextras/.mini_alue_ce

  # lib
  install -D lib/DB/DB.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/DB/DB.pm"
  install -D lib/LDAP.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/LDAP.pm"
  install -D lib/LocalConfig.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/LocalConfig.pm"
  install -D lib/Mon/Logger.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Mon/Logger.pm"
  install -D lib/Mon/LoggerSchema.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Mon/LoggerSchema.pm"
  install -D lib/Mon/Zmstat.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Mon/Zmstat.pm"
  install lib/SMTP.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SMTP.pm"
  install -D lib/SOAP/Soap.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap.pm"
  install -D lib/SOAP/Soap11.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap11.pm"
  install -D lib/SOAP/Soap12.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap12.pm"
  install -D lib/SOAP/XmlDoc.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/XmlDoc.pm"
  install -D lib/SOAP/XmlElement.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/XmlElement.pm"
  install -D lib/Util/Common.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Util/Common.pm"
  install -D lib/Util/LDAP.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Util/LDAP.pm"
  install -D lib/Util/Timezone.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Util/Timezone.pm"
  install -D lib/ZmClient.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/ZmClient.pm"
  # rpmconf
  # sudoers
  install -D rpmconf/Env/sudoers.d/carbonio \
    "${pkgdir}/etc/sudoers.d/carbonio"
  # Env
  install -D rpmconf/Env/zextras.bash_profile \
    "${pkgdir}/opt/zextras/.bash_profile"
  install -D rpmconf/Env/zextras.bashrc \
    "${pkgdir}/opt/zextras/.bashrc"
  install -D rpmconf/Env/zextras.exrc \
    "${pkgdir}/opt/zextras/.exrc"
  install -D rpmconf/Env/zextras.ldaprc \
    "${pkgdir}/opt/zextras/.ldaprc"
  install -D rpmconf/Env/zextras.platform \
    "${pkgdir}/opt/zextras/.platform"
  install -D rpmconf/Env/zextras.viminfo \
    "${pkgdir}/opt/zextras/.viminfo"
  install -D rpmconf/Env/crontabs/crontab \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab"
  install -D rpmconf/Env/crontabs/crontab.ldap \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.ldap"
  install -D rpmconf/Env/crontabs/crontab.logger \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.logger"
  install -D rpmconf/Env/crontabs/crontab.mta \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.mta"
  install -D rpmconf/Env/crontabs/crontab.store \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.store"
  # Install
  install -Dm755 rpmconf/Install/postinstall.pm \
    "${pkgdir}/opt/zextras/libexec/postinstall.pm"
  install -Dm755 rpmconf/Install/preinstall.pm \
    "${pkgdir}/opt/zextras/libexec/preinstall.pm"
  install -Dm755 rpmconf/Install/zmsetup.pl \
    "${pkgdir}/opt/zextras/libexec/zmsetup.pl"
  # Build
  install -Dm755 rpmconf/Build/get_plat_tag.sh \
    "${pkgdir}/opt/zextras/libexec/get_plat_tag.sh"
  install -Dm755 rpmconf/Build/get_plat_tag.sh \
    "${pkgdir}/opt/zextras/libexec/installer/bin/get_plat_tag.sh"
  # Conf
  install -D rpmconf/Conf/zmssl.cnf.in \
    "${pkgdir}/opt/zextras/conf/zmssl.cnf.in"
  # mta
  install -D mta/cbpolicyd.conf.in \
    "${pkgdir}/opt/zextras/conf/cbpolicyd.conf.in"
  install -D mta/clamd.conf.in \
    "${pkgdir}/opt/zextras/conf/clamd.conf.in"
  install -D mta/opendkim-localnets.conf.in \
    "${pkgdir}/opt/zextras/conf/opendkim-localnets.conf.in"
  install -D mta/opendkim.conf.in \
    "${pkgdir}/opt/zextras/conf/opendkim.conf.in"
  install -D mta/postfix_header_checks.in \
    "${pkgdir}/opt/zextras/conf/postfix_header_checks.in"
  install -D mta/salocal.cf.in \
    "${pkgdir}/opt/zextras/conf/salocal.cf.in"
  install -D mta/postfix_sasl_smtpd.conf \
    "${pkgdir}/opt/zextras/conf/sasl2/smtpd.conf.in"
  install -D mta/saslauthd.conf.in \
    "${pkgdir}/opt/zextras/conf/saslauthd.conf.in"
  install -D mta/zmconfigd/postfix_content_filter.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/postfix_content_filter.cf"
  install -D mta/zmconfigd/smtpd_end_of_data_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_end_of_data_restrictions.cf"
  install -D mta/zmconfigd/smtpd_recipient_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_recipient_restrictions.cf"
  install -D mta/zmconfigd/smtpd_relay_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_relay_restrictions.cf"
  install -D mta/zmconfigd/smtpd_sender_login_maps.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_sender_login_maps.cf"
  install -D mta/zmconfigd/smtpd_sender_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_sender_restrictions.cf"

  # REPOS
  # core-utils
  cd "${srcdir}/carbonio-core-utils"
  install -D src/bin/antispam-mysql \
    "${pkgdir}/opt/zextras/bin/antispam-mysql"
  install -D src/bin/antispam-mysql.server \
    "${pkgdir}/opt/zextras/bin/antispam-mysql.server"
  install -D src/bin/antispam-mysqladmin \
    "${pkgdir}/opt/zextras/bin/antispam-mysqladmin"
  install -D src/bin/carbonio \
    "${pkgdir}/opt/zextras/bin/carbonio"
  install -D src/bin/ldap.production \
    "${pkgdir}/opt/zextras/bin/ldap"
  install -D src/bin/mysql \
    "${pkgdir}/opt/zextras/bin/mysql"
  install -D src/bin/mysql.server \
    "${pkgdir}/opt/zextras/bin/mysql.server"
  install -D src/bin/mysqladmin \
    "${pkgdir}/opt/zextras/bin/mysqladmin"
  install -D src/bin/postconf \
    "${pkgdir}/opt/zextras/bin/postconf"
  install -D src/bin/postfix \
    "${pkgdir}/opt/zextras/bin/postfix"
  install -D src/bin/qshape \
    "${pkgdir}/opt/zextras/bin/qshape"
  install -D src/bin/zmaccts \
    "${pkgdir}/opt/zextras/bin/zmaccts"
  install -D src/bin/zmamavisdctl \
    "${pkgdir}/opt/zextras/bin/zmamavisdctl"
  install -D src/bin/zmantispamctl \
    "${pkgdir}/opt/zextras/bin/zmantispamctl"
  install -D src/bin/zmantispamdbpasswd \
    "${pkgdir}/opt/zextras/bin/zmantispamdbpasswd"
  install -D src/bin/zmantivirusctl \
    "${pkgdir}/opt/zextras/bin/zmantivirusctl"
  install -D src/bin/zmblobchk \
    "${pkgdir}/opt/zextras/bin/zmblobchk"
  install -D src/bin/zmcaldebug \
    "${pkgdir}/opt/zextras/bin/zmcaldebug"
  install -D src/bin/zmcbpadmin \
    "${pkgdir}/opt/zextras/bin/zmcbpadmin"
  install -D src/bin/zmcbpolicydctl \
    "${pkgdir}/opt/zextras/bin/zmcbpolicydctl"
  install -D src/bin/zmcertmgr \
    "${pkgdir}/opt/zextras/bin/zmcertmgr"
  install -D src/bin/zmclamdctl \
    "${pkgdir}/opt/zextras/bin/zmclamdctl"
  install -D src/bin/zmconfigdctl \
    "${pkgdir}/opt/zextras/bin/zmconfigdctl"
  install -D src/bin/zmcontactbackup \
    "${pkgdir}/opt/zextras/bin/zmcontactbackup"
  install -D src/bin/zmcontrol \
    "${pkgdir}/opt/zextras/bin/zmcontrol"
  install -D src/bin/zmdedupe \
    "${pkgdir}/opt/zextras/bin/zmdedupe"
  install -D src/bin/zmdhparam \
    "${pkgdir}/opt/zextras/bin/zmdhparam"
  install -D src/bin/zmdumpenv \
    "${pkgdir}/opt/zextras/bin/zmdumpenv"
  install -D src/bin/zmfixcalendtime \
    "${pkgdir}/opt/zextras/bin/zmfixcalendtime"
  install -D src/bin/zmfixcalprio \
    "${pkgdir}/opt/zextras/bin/zmfixcalprio"
  install -D src/bin/zmfreshclamctl \
    "${pkgdir}/opt/zextras/bin/zmfreshclamctl"
  install -D src/bin/zmgsautil \
    "${pkgdir}/opt/zextras/bin/zmgsautil"
  install -D src/bin/zmhostname \
    "${pkgdir}/opt/zextras/bin/zmhostname"
  install -D src/bin/zminnotop \
    "${pkgdir}/opt/zextras/bin/zminnotop"
  install -D src/bin/zmitemdatafile \
    "${pkgdir}/opt/zextras/bin/zmitemdatafile"
  install -D src/bin/zmjava \
    "${pkgdir}/opt/zextras/bin/zmjava"
  install -D src/bin/zmjavaext \
    "${pkgdir}/opt/zextras/bin/zmjavaext"
  install -D src/bin/zmldappasswd \
    "${pkgdir}/opt/zextras/bin/zmldappasswd"
  install -D src/bin/zmlmtpinject \
    "${pkgdir}/opt/zextras/bin/zmlmtpinject"
  install -D src/bin/zmlocalconfig \
    "${pkgdir}/opt/zextras/bin/zmlocalconfig"
  install -D src/bin/zmmailbox \
    "${pkgdir}/opt/zextras/bin/zmmailbox"
  install -D src/bin/zmmailboxdctl \
    "${pkgdir}/opt/zextras/bin/zmmailboxdctl"
  install -D src/bin/zmmemcachedctl \
    "${pkgdir}/opt/zextras/bin/zmmemcachedctl"
  install -D src/bin/zmmetadump \
    "${pkgdir}/opt/zextras/bin/zmmetadump"
  install -D src/bin/zmmigrateattrs \
    "${pkgdir}/opt/zextras/bin/zmmigrateattrs"
  install -D src/bin/zmmilterctl \
    "${pkgdir}/opt/zextras/bin/zmmilterctl"
  install -D src/bin/zmmtactl \
    "${pkgdir}/opt/zextras/bin/zmmtactl"
  install -D src/bin/zmmypasswd \
    "${pkgdir}/opt/zextras/bin/zmmypasswd"
  install -D src/bin/zmmysqlstatus \
    "${pkgdir}/opt/zextras/bin/zmmysqlstatus"
  install -D src/bin/zmmytop \
    "${pkgdir}/opt/zextras/bin/zmmytop"
  install -D src/bin/zmopendkimctl \
    "${pkgdir}/opt/zextras/bin/zmopendkimctl"
  install -D src/bin/zmplayredo \
    "${pkgdir}/opt/zextras/bin/zmplayredo"
  install -D src/bin/zmprov \
    "${pkgdir}/opt/zextras/bin/zmprov"
  install -D src/bin/zmproxyconf \
    "${pkgdir}/opt/zextras/bin/zmproxyconf"
  install -D src/bin/zmproxyctl \
    "${pkgdir}/opt/zextras/bin/zmproxyctl"
  install -D src/bin/zmpython \
    "${pkgdir}/opt/zextras/bin/zmpython"
  install -D src/bin/zmredodump \
    "${pkgdir}/opt/zextras/bin/zmredodump"
  install -D src/bin/zmresolverctl \
    "${pkgdir}/opt/zextras/bin/zmresolverctl"
  install -D src/bin/zmsaslauthdctl \
    "${pkgdir}/opt/zextras/bin/zmsaslauthdctl"
  install -D src/bin/zmshutil \
    "${pkgdir}/opt/zextras/bin/zmshutil"
  install -D src/bin/zmsoap \
    "${pkgdir}/opt/zextras/bin/zmsoap"
  install -D src/bin/zmsshkeygen \
    "${pkgdir}/opt/zextras/bin/zmsshkeygen"
  install -D src/bin/zmstat-chart \
    "${pkgdir}/opt/zextras/bin/zmstat-chart"
  install -D src/bin/zmstat-chart-config \
    "${pkgdir}/opt/zextras/bin/zmstat-chart-config"
  install -D src/bin/zmstatctl \
    "${pkgdir}/opt/zextras/bin/zmstatctl"
  install -D src/bin/zmstorectl \
    "${pkgdir}/opt/zextras/bin/zmstorectl"
  install -D src/bin/zmthrdump \
    "${pkgdir}/opt/zextras/bin/zmthrdump"
  install -D src/bin/zmtlsctl \
    "${pkgdir}/opt/zextras/bin/zmtlsctl"
  install -D src/bin/zmtotp \
    "${pkgdir}/opt/zextras/bin/zmtotp"
  install -D src/bin/zmtrainsa \
    "${pkgdir}/opt/zextras/bin/zmtrainsa"
  install -D src/bin/zmtzupdate \
    "${pkgdir}/opt/zextras/bin/zmtzupdate"
  install -D src/bin/zmupdateauthkeys \
    "${pkgdir}/opt/zextras/bin/zmupdateauthkeys"
  install -D src/bin/zmvolume \
    "${pkgdir}/opt/zextras/bin/zmvolume"
  install -Dm755 src/libexec/zcs \
    "${pkgdir}/opt/zextras/libexec/zcs"
  install -Dm755 src/libexec/carbonio \
    "${pkgdir}/opt/zextras/libexec/carbonio"
  install -Dm755 src/libexec/certbot \
    "${pkgdir}/opt/zextras/libexec/certbot"
  install -Dm755 src/libexec/zmaltermimeconfig \
    "${pkgdir}/opt/zextras/libexec/zmaltermimeconfig"
  install -Dm755 src/libexec/zmantispamdbinit \
    "${pkgdir}/opt/zextras/libexec/zmantispamdbinit"
  install -Dm755 src/libexec/zmantispammycnf \
    "${pkgdir}/opt/zextras/libexec/zmantispammycnf"
  install -Dm755 src/libexec/zmcbpolicydinit \
    "${pkgdir}/opt/zextras/libexec/zmcbpolicydinit"
  install -Dm755 src/libexec/zmcheckexpiredcerts \
    "${pkgdir}/opt/zextras/libexec/zmcheckexpiredcerts"
  install -Dm755 src/libexec/zmcleantmp \
    "${pkgdir}/opt/zextras/libexec/zmcleantmp"
  install -Dm755 src/libexec/zmclientcertmgr \
    "${pkgdir}/opt/zextras/libexec/zmclientcertmgr"
  install -Dm755 src/libexec/zmcompresslogs \
    "${pkgdir}/opt/zextras/libexec/zmcompresslogs"
  install -Dm755 src/libexec/zmcomputequotausage \
    "${pkgdir}/opt/zextras/libexec/zmcomputequotausage"
  install -Dm755 src/libexec/zmconfigd \
    "${pkgdir}/opt/zextras/libexec/zmconfigd"
  install -Dm755 src/libexec/zmcpustat \
    "${pkgdir}/opt/zextras/libexec/zmcpustat"
  install -Dm755 src/libexec/zmdailyreport \
    "${pkgdir}/opt/zextras/libexec/zmdailyreport"
  install -Dm755 src/libexec/zmdbintegrityreport \
    "${pkgdir}/opt/zextras/libexec/zmdbintegrityreport"
  install -Dm755 src/libexec/zmdiaglog \
    "${pkgdir}/opt/zextras/libexec/zmdiaglog"
  install -Dm755 src/libexec/zmdkimkeyutil \
    "${pkgdir}/opt/zextras/libexec/zmdkimkeyutil"
  install -Dm755 src/libexec/zmdomaincertmgr \
    "${pkgdir}/opt/zextras/libexec/zmdomaincertmgr"
  install -Dm755 src/libexec/zmexplainslow \
    "${pkgdir}/opt/zextras/libexec/zmexplainslow"
  install -Dm755 src/libexec/zmexplainsql \
    "${pkgdir}/opt/zextras/libexec/zmexplainsql"
  install -Dm755 src/libexec/zmextractsql \
    "${pkgdir}/opt/zextras/libexec/zmextractsql"
  install -Dm755 src/libexec/zmfixperms \
    "${pkgdir}/opt/zextras/libexec/zmfixperms"
  install -Dm755 src/libexec/zmfixreminder \
    "${pkgdir}/opt/zextras/libexec/zmfixreminder"
  install -Dm755 src/libexec/zmgsaupdate \
    "${pkgdir}/opt/zextras/libexec/zmgsaupdate"
  install -Dm755 src/libexec/zmhspreport \
    "${pkgdir}/opt/zextras/libexec/zmhspreport"
  install -Dm755 src/libexec/zminiutil \
    "${pkgdir}/opt/zextras/libexec/zminiutil"
  install -Dm755 src/libexec/zmiostat \
    "${pkgdir}/opt/zextras/libexec/zmiostat"
  install -Dm755 src/libexec/zmiptool \
    "${pkgdir}/opt/zextras/libexec/zmiptool"
  install -Dm755 src/libexec/zmjavawatch \
    "${pkgdir}/opt/zextras/libexec/zmjavawatch"
  install -Dm755 src/libexec/zmjsprecompile \
    "${pkgdir}/opt/zextras/libexec/zmjsprecompile"
  install -Dm755 src/libexec/600.zimbra \
    "${pkgdir}/opt/zextras/libexec/600.zimbra"
  install -Dm755 src/libexec/configrewrite \
    "${pkgdir}/opt/zextras/libexec/configrewrite"
  install -Dm755 src/libexec/icalmig \
    "${pkgdir}/opt/zextras/libexec/icalmig"
  install -D src/contrib/zmfetchercfg \
    "${pkgdir}/opt/zextras/contrib/zmfetchercfg"
  install -Dm755 src/libexec/zmlogprocess \
    "${pkgdir}/opt/zextras/libexec/zmlogprocess"
  install -Dm755 src/libexec/zmmsgtrace \
    "${pkgdir}/opt/zextras/libexec/zmmsgtrace"
  install -Dm755 src/libexec/zmmtainit \
    "${pkgdir}/opt/zextras/libexec/zmmtainit"
  install -Dm755 src/libexec/zmmtastatus \
    "${pkgdir}/opt/zextras/libexec/zmmtastatus"
  install -Dm755 src/libexec/zmmycnf \
    "${pkgdir}/opt/zextras/libexec/zmmycnf"
  install -Dm755 src/libexec/zmmyinit \
    "${pkgdir}/opt/zextras/libexec/zmmyinit"
  install -Dm755 src/libexec/zmpostfixpolicyd \
    "${pkgdir}/opt/zextras/libexec/zmpostfixpolicyd"
  install -Dm755 src/libexec/zmproxyconfgen \
    "${pkgdir}/opt/zextras/libexec/zmproxyconfgen"
  install -Dm755 src/libexec/zmproxyconfig \
    "${pkgdir}/opt/zextras/libexec/zmproxyconfig"
  install -Dm755 src/libexec/zmproxypurge \
    "${pkgdir}/opt/zextras/libexec/zmproxypurge"
  install -Dm755 src/libexec/zmqaction \
    "${pkgdir}/opt/zextras/libexec/zmqaction"
  install -Dm755 src/libexec/zmqstat \
    "${pkgdir}/opt/zextras/libexec/zmqstat"
  install -Dm755 src/libexec/zmqueuelog \
    "${pkgdir}/opt/zextras/libexec/zmqueuelog"
  install -Dm755 src/libexec/zmrc \
    "${pkgdir}/opt/zextras/libexec/zmrc"
  install -Dm755 src/libexec/zmrcd \
    "${pkgdir}/opt/zextras/libexec/zmrcd"
  install -Dm755 src/libexec/zmresetmysqlpassword \
    "${pkgdir}/opt/zextras/libexec/zmresetmysqlpassword"
  install -Dm755 src/libexec/zmsacompile \
    "${pkgdir}/opt/zextras/libexec/zmsacompile"
  install -Dm755 src/libexec/zmsaupdate \
    "${pkgdir}/opt/zextras/libexec/zmsaupdate"
  install -Dm755 src/libexec/zmserverips \
    "${pkgdir}/opt/zextras/libexec/zmserverips"
  install -Dm755 src/libexec/zmsetservername \
    "${pkgdir}/opt/zextras/libexec/zmsetservername"
  install -Dm755 src/libexec/zmspamextract \
    "${pkgdir}/opt/zextras/libexec/zmspamextract"
  install -Dm755 src/libexec/zmstat-allprocs \
    "${pkgdir}/opt/zextras/libexec/zmstat-allprocs"
  install -Dm755 src/libexec/zmstat-cleanup \
    "${pkgdir}/opt/zextras/libexec/zmstat-cleanup"
  install -Dm755 src/libexec/zmstat-convertd \
    "${pkgdir}/opt/zextras/libexec/zmstat-convertd"
  install -Dm755 src/libexec/zmstat-cpu \
    "${pkgdir}/opt/zextras/libexec/zmstat-cpu"
  install -Dm755 src/libexec/zmstat-df \
    "${pkgdir}/opt/zextras/libexec/zmstat-df"
  install -Dm755 src/libexec/zmstat-fd \
    "${pkgdir}/opt/zextras/libexec/zmstat-fd"
  install -Dm755 src/libexec/zmstat-io \
    "${pkgdir}/opt/zextras/libexec/zmstat-io"
  install -Dm755 src/libexec/zmstat-mtaqueue \
    "${pkgdir}/opt/zextras/libexec/zmstat-mtaqueue"
  install -Dm755 src/libexec/postfix-prometheus \
    "${pkgdir}/opt/zextras/libexec/postfix-prometheus"
  install -Dm755 src/libexec/zmstat-mysql \
    "${pkgdir}/opt/zextras/libexec/zmstat-mysql"
  install -Dm755 src/libexec/zmstat-nginx \
    "${pkgdir}/opt/zextras/libexec/zmstat-nginx"
  install -Dm755 src/libexec/zmstat-proc \
    "${pkgdir}/opt/zextras/libexec/zmstat-proc"
  install -Dm755 src/libexec/zmstat-vm \
    "${pkgdir}/opt/zextras/libexec/zmstat-vm"
  install -Dm755 src/libexec/zmstatuslog \
    "${pkgdir}/opt/zextras/libexec/zmstatuslog"
  install -Dm755 src/libexec/zmsyslogsetup \
    "${pkgdir}/opt/zextras/libexec/zmsyslogsetup"
  install -Dm755 src/libexec/zmthreadcpu \
    "${pkgdir}/opt/zextras/libexec/zmthreadcpu"
  install -Dm644 conf/zmlogrotate \
    "${pkgdir}/opt/zextras/conf/zmlogrotate"
  # ldap scripts
  install -Dm755 src/libexec/zmstat-ldap \
    "${pkgdir}/opt/zextras/libexec/zmstat-ldap"
  install -Dm755 src/libexec/zmldapanon \
    "${pkgdir}/opt/zextras/libexec/zmldapanon"
  install -Dm755 src/libexec/zmreplchk \
    "${pkgdir}/opt/zextras/libexec/zmreplchk"
  install -Dm755 src/libexec/zmslapadd \
    "${pkgdir}/opt/zextras/libexec/zmslapadd"
  install -Dm755 src/libexec/zmslapcat \
    "${pkgdir}/opt/zextras/libexec/zmslapcat"
  install -Dm755 src/libexec/zmslapd \
    "${pkgdir}/opt/zextras/libexec/zmslapd"
  install -Dm755 src/libexec/zmslapindex \
    "${pkgdir}/opt/zextras/libexec/zmslapindex"
  install -Dm755 src/libexec/zmldapapplyldif \
    "${pkgdir}/opt/zextras/libexec/zmldapapplyldif"
  install -Dm755 src/libexec/zmldapenable-mmr \
    "${pkgdir}/opt/zextras/libexec/zmldapenable-mmr"
  install -Dm755 src/libexec/zmldapenablereplica \
    "${pkgdir}/opt/zextras/libexec/zmldapenablereplica"
  install -Dm755 src/libexec/zmldapinit \
    "${pkgdir}/opt/zextras/libexec/zmldapinit"
  install -Dm755 src/libexec/zmldapmmrtool \
    "${pkgdir}/opt/zextras/libexec/zmldapmmrtool"
  install -Dm755 src/libexec/zmldapmonitordb \
    "${pkgdir}/opt/zextras/libexec/zmldapmonitordb"
  install -Dm755 src/libexec/zmldappromote-replica-mmr \
    "${pkgdir}/opt/zextras/libexec/zmldappromote-replica-mmr"
  install -Dm755 src/libexec/zmldapreplicatool \
    "${pkgdir}/opt/zextras/libexec/zmldapreplicatool"
  install -Dm755 src/libexec/zmldapschema \
    "${pkgdir}/opt/zextras/libexec/zmldapschema"
  install -Dm755 src/libexec/zmldapupdateldif \
    "${pkgdir}/opt/zextras/libexec/zmldapupdateldif"
  install -Dm755 src/libexec/ldapattributeupdate \
    "${pkgdir}/opt/zextras/libexec/ldapattributeupdate"
  install -D conf/zmconfigd.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd.cf"
  install -D conf/zmconfigd.log4j.properties \
    "${pkgdir}/opt/zextras/conf/zmconfigd.log4j.properties"
  # systemd env script
  # it generates /opt/zextras/data/systemd.env
  install -Dm755 src/bin/systemd-envscript \
    "${pkgdir}/opt/zextras/bin/systemd-envscript"

  # jython
  cd "${srcdir}/carbonio-jython"
  install -D jylibs/commands.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/commands.py"
  install -D jylibs/conf.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/conf.py"
  install -D jylibs/config.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/config.py"
  install -D jylibs/globalconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/globalconfig.py"
  install -D jylibs/ldap.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/ldap.py"
  install -D jylibs/listener.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/listener.py"
  install -D jylibs/localconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/localconfig.py"
  install -D jylibs/logmsg.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/logmsg.py"
  install -D jylibs/miscconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/miscconfig.py"
  install -D jylibs/mtaconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/mtaconfig.py"
  install -D jylibs/serverconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/serverconfig.py"
  install -D jylibs/state.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/state.py"

  # amavis
  cd "${srcdir}/carbonio-amavis"
  install -D conf/amavisd/amavisd-custom.conf \
    "${pkgdir}/opt/zextras/conf/amavisd-custom.conf"
  install -D conf/amavisd.conf.in \
    "${pkgdir}/opt/zextras/conf/amavisd.conf.in"
  install -D conf/dspam.conf.in \
    "${pkgdir}/opt/zextras/conf/dspam.conf.in"

  # freshclam
  cd "${srcdir}/carbonio-freshclam"
  install -D freshclam.conf.in \
    "${pkgdir}/opt/zextras/conf/freshclam.conf.in"

  # carbonio-certificate-manager
  cd "${srcdir}"
  install -Ddm755 "${pkgdir}/opt/zextras/lib/ext/com_zimbra_cert_manager"
  install -D zm-certificate-manager-store-23.2.0.jar \
    "${pkgdir}/opt/zextras/lib/ext/com_zimbra_cert_manager/com_zimbra_cert_manager.jar"

  # junixsocket-native
  install -D junixsocket-native-2.4.0.nar \
    -t "${pkgdir}/opt/zextras/lib"

  echo "24.7.0" >"${pkgdir}"/opt/zextras/.version

  # systemd resources
  install -Dm 644 "${srcdir}/carbonio-configd.service" \
    "${pkgdir}/lib/systemd/system/carbonio-configd.service"
  install -Dm 644 "${srcdir}/carbonio-stats.service" \
    "${pkgdir}/lib/systemd/system/carbonio-stats.service"
  install -Dm 644 "${srcdir}/carbonio-tmpfile.conf" \
    "${pkgdir}/usr/lib/tmpfiles.d/carbonio.conf"
}

postrm__apt() {
  if [ "$1" = purge ]; then
    if crontab -l -u "zextras" >"/dev/null"; then
      crontab -r -u "zextras"
    fi
  fi
}

postrm__yum() {
  if crontab -l -u "zextras" >"/dev/null"; then
    crontab -r -u "zextras"
  fi
}

postinst__apt() {
  if [ "$1" = "configure" ]; then
    # creating zextras group if it isn't already there
    if ! getent group zextras >/dev/null; then
      addgroup --system --force-badname --quiet zextras
    fi

    # creating zextras user if it isn't already there
    if ! getent passwd zextras >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup zextras \
        --home /opt/zextras \
        --shell /bin/bash \
        zextras
      usermod -c "zextras user" zextras
    fi

    # creating postfix and postdrop groups if aren't already there
    if ! getent group postdrop >/dev/null; then
      addgroup --system --force-badname --quiet postdrop
    fi
    if ! getent group postfix >/dev/null; then
      addgroup --system --force-badname --quiet postfix
    fi

    # creating postfix user if it isn't already there
    if ! getent passwd postfix >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup postfix \
        --home /opt/zextras/postfix \
        postfix
      usermod -c "postfix user" postfix
    fi
    usermod -a -G postfix,tty zextras
  fi

  if [ -d "/opt/zextras/common/certbot/etc/letsencrypt" ]; then
    chown -R zextras:zextras /opt/zextras/common/certbot/etc/letsencrypt
  fi

  if [ ! -d "/opt/zextras/common/conf" ]; then
    mkdir -p /opt/zextras/common/conf
    chown -R zextras:zextras /opt/zextras/common/conf
  fi

  if [ ! -d "/opt/zextras/conf/ca" ]; then
    mkdir -p /opt/zextras/conf/ca
    chown -R zextras:zextras /opt/zextras/conf/ca
  fi

  if [ -f "/opt/zextras/conf/ca/ca.pem" ]; then
    ln -f -s ca.pem "/opt/zextras/conf/ca/$(openssl x509 -hash -noout -in /opt/zextras/conf/ca/ca.pem).0"
  fi

  sed -i -e '/^::1     ip6-localhost ip6-loopback localhost$/!s/::1     ip6-localhost ip6-loopback/::1     ip6-localhost ip6-loopback localhost/' /etc/hosts
  sed -i -e 's/# session    required   pam_limits.so/session    required   pam_limits.so/' /etc/pam.d/su
  pamtmp=$(mktemp -t zpamtmp.XXXXXX 2>/dev/null) || {
    echo "Failed to create tmpfile"
    exit 1
  }
  {
    grep -E -v -e '^session[[:space:]]+required[[:space:]]+pam_limits.so' /etc/pam.d/common-session >"$pamtmp"
    echo "session	required	pam_limits.so"
  } >>"$pamtmp"
  mv -f "$pamtmp" /etc/pam.d/common-session
  chmod 640 /etc/pam.d/common-session
  chown -R root:root /opt/zextras/common/lib/perl5/Zimbra

  if [ -d /etc/logrotate.d ]; then
    cp -f /opt/zextras/conf/zmlogrotate /etc/logrotate.d/carbonio
  fi

  cp -f /opt/zextras/libexec/carbonio /etc/init.d/carbonio
  chmod 755 /etc/init.d/carbonio
  if [ -x /usr/sbin/update-rc.d ]; then
    update-rc.d -f carbonio remove
    update-rc.d carbonio start 99 3 5 . stop 01 0 1 6 .
  else
    rm -f /etc/rc*.d/S99carbonio
    rm -f /etc/rc*.d/S89carbonio
    rm -f /etc/rc*.d/K01carbonio

    if [ -d /etc/rc0.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc0.d/S89carbonio
      ln -s /etc/init.d/carbonio /etc/rc0.d/K01carbonio
    fi
    if [ -d /etc/rc1.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc1.d/K01carbonio
    fi
    if [ -d /etc/rc2.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc2.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc2.d/K01carbonio
    fi
    if [ -d /etc/rc3.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc3.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc3.d/K01carbonio
    fi
    if [ -d /etc/rc4.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc4.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc4.d/K01carbonio
    fi
    if [ -d /etc/rc5.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc5.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc5.d/K01carbonio
    fi
    if [ -d /etc/rc6.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc6.d/S89carbonio
      ln -s /etc/init.d/carbonio /etc/rc6.d/K01carbonio
    fi

  fi

  mkdir -p /opt/zextras/backup
  chown zextras:zextras /opt/zextras/backup
  mkdir -p /opt/zextras/log
  chown zextras:zextras /opt/zextras/log
  mkdir -p /opt/zextras/ssl
  chown zextras:zextras /opt/zextras/ssl
  mkdir -p /opt/zextras/.ssh
  chown zextras:zextras /opt/zextras/.ssh
  mkdir -p /opt/zextras/zmstat
  chown zextras:zextras /opt/zextras/zmstat
  systemd-tmpfiles --create

  if grep -E -q '^%zextras[[:space:]]' /etc/sudoers; then
    sudotmp=$(mktemp -t zsudoers.XXXXXX 2>/dev/null) || {
      echo "Failed to create tmpfile"
      exit 1
    }
    SUDOMODE=$(perl -e 'my $mode=(stat("/etc/sudoers"))[2];if ($mode == "0000"){ $mode=33056 };printf("%04o\n",$mode & 07777);')
    grep -E -v -e '^%zextras[[:space:]]' /etc/sudoers >"$sudotmp"
    mv -f "$sudotmp" /etc/sudoers
    chmod "$SUDOMODE" /etc/sudoers
  fi

  chmod 440 /etc/sudoers.d/carbonio
  chown root:root /etc/sudoers.d/carbonio

  echo "$(date +%s): INSTALLED carbonio-core" >>/opt/zextras/.install_history

  if [ -x "/opt/zextras/libexec/zmfixperms" ]; then
    /opt/zextras/libexec/zmfixperms
  fi

}

postinst__yum() {
  # creating zextras group if it isn't already there
  if ! getent group zextras >/dev/null; then
    groupadd --system zextras >/dev/null
  fi
  # creating zextras user if it isn't already there
  if ! getent passwd zextras >/dev/null; then
    useradd --system \
      -g zextras \
      -d /opt/zextras \
      --shell /bin/bash \
      zextras >/dev/null
    usermod -c "zextras user" zextras
  fi

  # creating postfix and postdrop groups if aren't already there
  if ! getent group postdrop >/dev/null; then
    groupadd --system postdrop >/dev/null
  fi
  if ! getent group postfix >/dev/null; then
    groupadd --system postfix >/dev/null
  fi

  # creating postfix user if it isn't already there
  if ! getent passwd postfix >/dev/null; then
    useradd --system \
      -g postfix \
      -d /opt/zextras/postfix \
      postfix
    usermod -c "postfix user" postfix
  fi
  usermod -a -G postfix,tty zextras

  # creating postfix user if it isn't already there
  if ! getent passwd syslog >/dev/null; then
    useradd --system \
      -g adm \
      syslog
    usermod -c "syslog user" syslog
  fi

  if [ -d "/opt/zextras/common/certbot/etc/letsencrypt" ]; then
    chown -R zextras:zextras /opt/zextras/common/certbot/etc/letsencrypt
  fi

  if [ ! -d "/opt/zextras/common/conf" ]; then
    mkdir -p /opt/zextras/common/conf
    chown -R zextras:zextras /opt/zextras/common/conf
  fi

  if [ ! -d "/opt/zextras/conf/ca" ]; then
    mkdir -p /opt/zextras/conf/ca
    chown -R zextras:zextras /opt/zextras/conf/ca
  fi

  if [ -f "/opt/zextras/conf/ca/ca.pem" ]; then
    ln -f -s ca.pem "/opt/zextras/conf/ca/$(openssl x509 -hash -noout -in /opt/zextras/conf/ca/ca.pem).0"
  fi

  if [ -d /etc/logrotate.d ]; then
    cp -f /opt/zextras/conf/zmlogrotate /etc/logrotate.d/carbonio
  fi

  if [ -d /etc/init.d ]; then
    cp -f /opt/zextras/libexec/carbonio /etc/init.d/carbonio
    chmod 755 /etc/init.d/carbonio
    if [ -x /sbin/chkconfig ]; then
      chkconfig --del carbonio
      chkconfig --add carbonio
      chkconfig carbonio on
    else
      rm -f /etc/rc*.d/S99carbonio
      rm -f /etc/rc*.d/S89carbonio
      rm -f /etc/rc*.d/K01carbonio

      if [ -d /etc/rc0.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc0.d/S89carbonio
        ln -s /etc/init.d/carbonio /etc/rc0.d/K01carbonio
      fi
      if [ -d /etc/rc1.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc1.d/K01carbonio
      fi
      if [ -d /etc/rc2.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc2.d/S99carbonio
        ln -s /etc/init.d/carbonio /etc/rc2.d/K01carbonio
      fi
      if [ -d /etc/rc3.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc3.d/S99carbonio
        ln -s /etc/init.d/carbonio /etc/rc3.d/K01carbonio
      fi
      if [ -d /etc/rc4.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc4.d/S99carbonio
        ln -s /etc/init.d/carbonio /etc/rc4.d/K01carbonio
      fi
      if [ -d /etc/rc5.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc5.d/S99carbonio
        ln -s /etc/init.d/carbonio /etc/rc5.d/K01carbonio
      fi
      if [ -d /etc/rc6.d ]; then
        ln -s /etc/init.d/carbonio /etc/rc6.d/S89carbonio
        ln -s /etc/init.d/carbonio /etc/rc6.d/K01carbonio
      fi
    fi
  fi

  mkdir -p /opt/zextras/backup
  chown zextras:zextras /opt/zextras/backup
  mkdir -p /opt/zextras/log
  chown zextras:zextras /opt/zextras/log
  mkdir -p /opt/zextras/ssl
  chown zextras:zextras /opt/zextras/ssl
  mkdir -p /opt/zextras/.ssh
  chown zextras:zextras /opt/zextras/.ssh
  mkdir -p /opt/zextras/zmstat
  chown zextras:zextras /opt/zextras/zmstat
  systemd-tmpfiles --create

  if grep -E -q '^%zextras[[:space:]]' /etc/sudoers; then
    sudotmp=$(mktemp -t zsudoers.XXXXXX 2>/dev/null) || {
      echo "Failed to create tmpfile"
      exit 1
    }
    SUDOMODE=$(perl -e 'my $mode=(stat("/etc/sudoers"))[2];if ($mode == "0000"){ $mode=33056 };printf("%04o\n",$mode & 07777);')
    grep -E -v -e '^%zextras[[:space:]]' /etc/sudoers >"$sudotmp"
    mv -f "$sudotmp" /etc/sudoers
    chmod "$SUDOMODE" /etc/sudoers
  fi

  chmod 440 /etc/sudoers.d/carbonio
  chown root:root /etc/sudoers.d/carbonio

  echo "$(date +%s): INSTALLED carbonio-core" >>/opt/zextras/.install_history

  if [ -x "/opt/zextras/libexec/zmfixperms" ]; then
    /opt/zextras/libexec/zmfixperms
  fi
}
