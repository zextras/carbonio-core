targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-core"
pkgver="4.0.22"
pkgrel="2"
pkgdesc="An open-source, community-driven email server"
pkgdesclong=(
  "An open-source, community-driven email server"
)
maintainer="Zextras <packages@zextras.com>"
url="https://zextras.com"
section="mail"
priority="optional"
arch="amd64"
depends:ubuntu-focal=(
  "adduser"
  "carbonio-common-appserver-conf"
  "carbonio-common-appserver-db"
  "carbonio-common-appserver-native-lib"
  "carbonio-common-core-jar"
  "carbonio-common-core-libs"
  "carbonio-innotop"
  "carbonio-perl-carp-clan"
  "carbonio-perl-crypt-saltedhash"
  "carbonio-perl-data-uuid"
  "carbonio-perl-date-manip"
  "carbonio-perl-dbi"
  "carbonio-perl-file-grep"
  "carbonio-perl-filesys-df"
  "carbonio-perl-io-compress"
  "carbonio-perl-json-pp"
  "carbonio-perl-netaddr-ip"
  "carbonio-perl-net-dns"
  "carbonio-perl-net-ldap"
  "carbonio-perl-xml-simple"
  "carbonio-openjdk-cacerts"
  "carbonio-openjdk"
  "carbonio-openldap"
  "carbonio-openssl"
  "carbonio-prometheus-node-exporter"
  "carbonio-timezone-data"
  "coreutils"
  "file"
  "fontconfig"
  "iproute2"
  "libaio1"
  "libexpat1"
  "libgmp10"
  "libidn11"
  "libpcre3"
  "libperl5.30"
  "libsocket6-perl"
  "libstdc++6"
  "lsb-release"
  "net-tools"
  "netcat-openbsd"
  "openssh-client"
  "passwd"
  "pax"
  "pending-setups"
  "perl"
  "procps"
  "resolvconf"
  "rsyslog"
  "service-discover"
  "sudo"
  "sysstat" 
  "unzip"
)
depends:yum=(
  "carbonio-common-appserver-conf"
  "carbonio-common-appserver-db"
  "carbonio-common-appserver-native-lib"
  "carbonio-common-core-jar"
  "carbonio-common-core-libs"
  "carbonio-innotop"
  "carbonio-perl-carp-clan"
  "carbonio-perl-crypt-saltedhash"
  "carbonio-perl-data-uuid"
  "carbonio-perl-date-manip"
  "carbonio-perl-dbi"
  "carbonio-perl-file-grep"
  "carbonio-perl-filesys-df"
  "carbonio-perl-io-compress"
  "carbonio-perl-json-pp"
  "carbonio-perl-netaddr-ip"
  "carbonio-perl-net-dns"
  "carbonio-perl-net-ldap"
  "carbonio-perl-xml-simple"
  "carbonio-openjdk-cacerts"
  "carbonio-openldap"
  "carbonio-openjdk"
  "carbonio-openssl"
  "carbonio-prometheus-node-exporter"
  "carbonio-timezone-data"
  "coreutils"
  "expat"
  "file"
  "fontconfig"
  "gmp"
  "iproute"
  "libaio"
  "libidn"
  "libstdc++"
  "net-tools"
  "nmap-ncat"
  "openssh"
  "pcre"
  "pending-setups"
  "perl-core"
  "perl-Socket6"
  "perl"
  "rsyslog"
  "service-discover"
  "shadow-utils"
  "sudo"
  "sysstat"
  "unzip"
)
provides:yum=(
  "/usr/bin/zmpython"
)
optdepends=(
  "carbonio-common-appserver-docs"
)
sources=(
  "carbonio-bootstrap"
  "mini_alue_ce"
)
hashsums=(
  "SKIP"
  "SKIP"
)

package() {
  cd "${srcdir}"/../../
  install -D etc/sudoers.d/carbonio \
    "${pkgdir}/etc/sudoers.d/carbonio"
  install -D opt/zextras/.bash_profile \
    "${pkgdir}/opt/zextras/.bash_profile"
  install -D opt/zextras/.bashrc \
    "${pkgdir}/opt/zextras/.bashrc"
  install -D opt/zextras/.exrc \
    "${pkgdir}/opt/zextras/.exrc"
  install -D opt/zextras/.ldaprc \
    "${pkgdir}/opt/zextras/.ldaprc"
  install -D opt/zextras/.platform \
    "${pkgdir}/opt/zextras/.platform"
  install -D opt/zextras/.viminfo \
    "${pkgdir}/opt/zextras/.viminfo"
  install -D opt/zextras/bin/antispam-mysql \
    "${pkgdir}/opt/zextras/bin/antispam-mysql"
  install -D opt/zextras/bin/antispam-mysql.server \
    "${pkgdir}/opt/zextras/bin/antispam-mysql.server"
  install -D opt/zextras/bin/antispam-mysqladmin \
    "${pkgdir}/opt/zextras/bin/antispam-mysqladmin"
  install -D opt/zextras/bin/carbonio \
    "${pkgdir}/opt/zextras/bin/carbonio"
  install -D opt/zextras/bin/ldap \
    "${pkgdir}/opt/zextras/bin/ldap"
  install -D opt/zextras/bin/mysql \
    "${pkgdir}/opt/zextras/bin/mysql"
  install -D opt/zextras/bin/mysql.server \
    "${pkgdir}/opt/zextras/bin/mysql.server"
  install -D opt/zextras/bin/mysqladmin \
    "${pkgdir}/opt/zextras/bin/mysqladmin"
  install -D opt/zextras/bin/postconf \
    "${pkgdir}/opt/zextras/bin/postconf"
  install -D opt/zextras/bin/postfix \
    "${pkgdir}/opt/zextras/bin/postfix"
  install -D opt/zextras/bin/qshape \
    "${pkgdir}/opt/zextras/bin/qshape"
  install -D opt/zextras/bin/zmaccts \
    "${pkgdir}/opt/zextras/bin/zmaccts"
  install -D opt/zextras/bin/zmamavisdctl \
    "${pkgdir}/opt/zextras/bin/zmamavisdctl"
  install -D opt/zextras/bin/zmantispamctl \
    "${pkgdir}/opt/zextras/bin/zmantispamctl"
  install -D opt/zextras/bin/zmantispamdbpasswd \
    "${pkgdir}/opt/zextras/bin/zmantispamdbpasswd"
  install -D opt/zextras/bin/zmantivirusctl \
    "${pkgdir}/opt/zextras/bin/zmantivirusctl"
  install -D opt/zextras/bin/zmblobchk \
    "${pkgdir}/opt/zextras/bin/zmblobchk"
  install -D opt/zextras/bin/zmcaldebug \
    "${pkgdir}/opt/zextras/bin/zmcaldebug"
  install -D opt/zextras/bin/zmcbpadmin \
    "${pkgdir}/opt/zextras/bin/zmcbpadmin"
  install -D opt/zextras/bin/zmcbpolicydctl \
    "${pkgdir}/opt/zextras/bin/zmcbpolicydctl"
  install -D opt/zextras/bin/zmcertmgr \
    "${pkgdir}/opt/zextras/bin/zmcertmgr"
  install -D opt/zextras/bin/zmclamdctl \
    "${pkgdir}/opt/zextras/bin/zmclamdctl"
  install -D opt/zextras/bin/zmconfigdctl \
    "${pkgdir}/opt/zextras/bin/zmconfigdctl"
  install -D opt/zextras/bin/zmcontactbackup \
    "${pkgdir}/opt/zextras/bin/zmcontactbackup"
  install -D opt/zextras/bin/zmcontrol \
    "${pkgdir}/opt/zextras/bin/zmcontrol"
  install -D opt/zextras/bin/zmdedupe \
    "${pkgdir}/opt/zextras/bin/zmdedupe"
  install -D opt/zextras/bin/zmdhparam \
    "${pkgdir}/opt/zextras/bin/zmdhparam"
  install -D opt/zextras/bin/zmdumpenv \
    "${pkgdir}/opt/zextras/bin/zmdumpenv"
  install -D opt/zextras/bin/zmfixcalendtime \
    "${pkgdir}/opt/zextras/bin/zmfixcalendtime"
  install -D opt/zextras/bin/zmfixcalprio \
    "${pkgdir}/opt/zextras/bin/zmfixcalprio"
  install -D opt/zextras/bin/zmfreshclamctl \
    "${pkgdir}/opt/zextras/bin/zmfreshclamctl"
  install -D opt/zextras/bin/zmgsautil \
    "${pkgdir}/opt/zextras/bin/zmgsautil"
  install -D opt/zextras/bin/zmhostname \
    "${pkgdir}/opt/zextras/bin/zmhostname"
  install -D opt/zextras/bin/zminnotop \
    "${pkgdir}/opt/zextras/bin/zminnotop"
  install -D opt/zextras/bin/zmitemdatafile \
    "${pkgdir}/opt/zextras/bin/zmitemdatafile"
  install -D opt/zextras/bin/zmjava \
    "${pkgdir}/opt/zextras/bin/zmjava"
  install -D opt/zextras/bin/zmjavaext \
    "${pkgdir}/opt/zextras/bin/zmjavaext"
  install -D opt/zextras/bin/zmldappasswd \
    "${pkgdir}/opt/zextras/bin/zmldappasswd"
  install -D opt/zextras/bin/zmldapupgrade \
    "${pkgdir}/opt/zextras/bin/zmldapupgrade"
  install -D opt/zextras/bin/zmlmtpinject \
    "${pkgdir}/opt/zextras/bin/zmlmtpinject"
  install -D opt/zextras/bin/zmlocalconfig \
    "${pkgdir}/opt/zextras/bin/zmlocalconfig"
  install -D opt/zextras/bin/zmmailbox \
    "${pkgdir}/opt/zextras/bin/zmmailbox"
  install -D opt/zextras/bin/zmmailboxdctl \
    "${pkgdir}/opt/zextras/bin/zmmailboxdctl"
  install -D opt/zextras/bin/zmmemcachedctl \
    "${pkgdir}/opt/zextras/bin/zmmemcachedctl"
  install -D opt/zextras/bin/zmmetadump \
    "${pkgdir}/opt/zextras/bin/zmmetadump"
  install -D opt/zextras/bin/zmmigrateattrs \
    "${pkgdir}/opt/zextras/bin/zmmigrateattrs"
  install -D opt/zextras/bin/zmmilterctl \
    "${pkgdir}/opt/zextras/bin/zmmilterctl"
  install -D opt/zextras/bin/zmmtactl \
    "${pkgdir}/opt/zextras/bin/zmmtactl"
  install -D opt/zextras/bin/zmmypasswd \
    "${pkgdir}/opt/zextras/bin/zmmypasswd"
  install -D opt/zextras/bin/zmmysqlstatus \
    "${pkgdir}/opt/zextras/bin/zmmysqlstatus"
  install -D opt/zextras/bin/zmmytop \
    "${pkgdir}/opt/zextras/bin/zmmytop"
  install -D opt/zextras/bin/zmopendkimctl \
    "${pkgdir}/opt/zextras/bin/zmopendkimctl"
  install -D opt/zextras/bin/zmplayredo \
    "${pkgdir}/opt/zextras/bin/zmplayredo"
  install -D opt/zextras/bin/zmprov \
    "${pkgdir}/opt/zextras/bin/zmprov"
  install -D opt/zextras/bin/zmproxyconf \
    "${pkgdir}/opt/zextras/bin/zmproxyconf"
  install -D opt/zextras/bin/zmproxyctl \
    "${pkgdir}/opt/zextras/bin/zmproxyctl"
  install -D opt/zextras/bin/zmpython \
    "${pkgdir}/opt/zextras/bin/zmpython"
  install -D opt/zextras/bin/zmredodump \
    "${pkgdir}/opt/zextras/bin/zmredodump"
  install -D opt/zextras/bin/zmresolverctl \
    "${pkgdir}/opt/zextras/bin/zmresolverctl"
  install -D opt/zextras/bin/zmsaslauthdctl \
    "${pkgdir}/opt/zextras/bin/zmsaslauthdctl"
  install -D opt/zextras/bin/zmshutil \
    "${pkgdir}/opt/zextras/bin/zmshutil"
  install -D opt/zextras/bin/zmskindeploy \
    "${pkgdir}/opt/zextras/bin/zmskindeploy"
  install -D opt/zextras/bin/zmsoap \
    "${pkgdir}/opt/zextras/bin/zmsoap"
  install -D opt/zextras/bin/zmsshkeygen \
    "${pkgdir}/opt/zextras/bin/zmsshkeygen"
  install -D opt/zextras/bin/zmstat-chart \
    "${pkgdir}/opt/zextras/bin/zmstat-chart"
  install -D opt/zextras/bin/zmstat-chart-config \
    "${pkgdir}/opt/zextras/bin/zmstat-chart-config"
  install -D opt/zextras/bin/zmstatctl \
    "${pkgdir}/opt/zextras/bin/zmstatctl"
  install -D opt/zextras/bin/zmstorectl \
    "${pkgdir}/opt/zextras/bin/zmstorectl"
  install -D opt/zextras/bin/zmthrdump \
    "${pkgdir}/opt/zextras/bin/zmthrdump"
  install -D opt/zextras/bin/zmtlsctl \
    "${pkgdir}/opt/zextras/bin/zmtlsctl"
  install -D opt/zextras/bin/zmtotp \
    "${pkgdir}/opt/zextras/bin/zmtotp"
  install -D opt/zextras/bin/zmtrainsa \
    "${pkgdir}/opt/zextras/bin/zmtrainsa"
  install -D opt/zextras/bin/zmtzupdate \
    "${pkgdir}/opt/zextras/bin/zmtzupdate"
  install -D opt/zextras/bin/zmupdateauthkeys \
    "${pkgdir}/opt/zextras/bin/zmupdateauthkeys"
  install -D opt/zextras/bin/zmvolume \
    "${pkgdir}/opt/zextras/bin/zmvolume"
  install -D opt/zextras/bin/zmzimletctl \
    "${pkgdir}/opt/zextras/bin/zmzimletctl"
  install -D opt/zextras/common/lib/jylibs/commands.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/commands.py"
  install -D opt/zextras/common/lib/jylibs/conf.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/conf.py"
  install -D opt/zextras/common/lib/jylibs/config.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/config.py"
  install -D opt/zextras/common/lib/jylibs/globalconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/globalconfig.py"
  install -D opt/zextras/common/lib/jylibs/ldap.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/ldap.py"
  install -D opt/zextras/common/lib/jylibs/listener.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/listener.py"
  install -D opt/zextras/common/lib/jylibs/localconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/localconfig.py"
  install -D opt/zextras/common/lib/jylibs/logmsg.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/logmsg.py"
  install -D opt/zextras/common/lib/jylibs/miscconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/miscconfig.py"
  install -D opt/zextras/common/lib/jylibs/mtaconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/mtaconfig.py"
  install -D opt/zextras/common/lib/jylibs/serverconfig.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/serverconfig.py"
  install -D opt/zextras/common/lib/jylibs/state.py \
    "${pkgdir}/opt/zextras/common/lib/jylibs/state.py"
  install -D opt/zextras/common/lib/perl5/Zimbra/DB/DB.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/DB/DB.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/LDAP.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/LDAP.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/LocalConfig.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/LocalConfig.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/Mon/Logger.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Mon/Logger.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/Mon/LoggerSchema.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Mon/LoggerSchema.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/Mon/Zmstat.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Mon/Zmstat.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/SMTP.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SMTP.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap11.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap11.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap12.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/Soap12.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/SOAP/XmlDoc.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/XmlDoc.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/SOAP/XmlElement.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/SOAP/XmlElement.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/Util/Common.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Util/Common.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/Util/LDAP.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Util/LDAP.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/Util/Timezone.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/Util/Timezone.pm"
  install -D opt/zextras/common/lib/perl5/Zimbra/ZmClient.pm \
    "${pkgdir}/opt/zextras/common/lib/perl5/Zimbra/ZmClient.pm"
  install -D opt/zextras/conf/amavisd-custom.conf \
    "${pkgdir}/opt/zextras/conf/amavisd-custom.conf"
  install -D opt/zextras/conf/amavisd.conf.in \
    "${pkgdir}/opt/zextras/conf/amavisd.conf.in"
  install -D opt/zextras/conf/cbpolicyd.conf.in \
    "${pkgdir}/opt/zextras/conf/cbpolicyd.conf.in"
  install -D opt/zextras/conf/clamd.conf.in \
    "${pkgdir}/opt/zextras/conf/clamd.conf.in"
  install -D opt/zextras/conf/crontabs/crontab \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab"
  install -D opt/zextras/conf/crontabs/crontab.ldap \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.ldap"
  install -D opt/zextras/conf/crontabs/crontab.logger \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.logger"
  install -D opt/zextras/conf/crontabs/crontab.mta \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.mta"
  install -D opt/zextras/conf/crontabs/crontab.store \
    "${pkgdir}/opt/zextras/conf/crontabs/crontab.store"
  install -D opt/zextras/conf/dspam.conf.in \
    "${pkgdir}/opt/zextras/conf/dspam.conf.in"
  install -D opt/zextras/conf/externaldirsync/Exchange2000.xml \
    "${pkgdir}/opt/zextras/conf/externaldirsync/Exchange2000.xml"
  install -D opt/zextras/conf/externaldirsync/Exchange2003.xml \
    "${pkgdir}/opt/zextras/conf/externaldirsync/Exchange2003.xml"
  install -D opt/zextras/conf/externaldirsync/Exchange5.5.xml \
    "${pkgdir}/opt/zextras/conf/externaldirsync/Exchange5.5.xml"
  install -D opt/zextras/conf/externaldirsync/domino.xml \
    "${pkgdir}/opt/zextras/conf/externaldirsync/domino.xml"
  install -D opt/zextras/conf/externaldirsync/novellGroupWise.xml \
    "${pkgdir}/opt/zextras/conf/externaldirsync/novellGroupWise.xml"
  install -D opt/zextras/conf/externaldirsync/openldap.xml \
    "${pkgdir}/opt/zextras/conf/externaldirsync/openldap.xml"
  install -D opt/zextras/conf/freshclam.conf.in \
    "${pkgdir}/opt/zextras/conf/freshclam.conf.in"
  install -D opt/zextras/conf/opendkim-localnets.conf.in \
    "${pkgdir}/opt/zextras/conf/opendkim-localnets.conf.in"
  install -D opt/zextras/conf/opendkim.conf.in \
    "${pkgdir}/opt/zextras/conf/opendkim.conf.in"
  install -D opt/zextras/conf/postfix_header_checks.in \
    "${pkgdir}/opt/zextras/conf/postfix_header_checks.in"
  install -D opt/zextras/conf/salocal.cf.in \
    "${pkgdir}/opt/zextras/conf/salocal.cf.in"
  install -D opt/zextras/conf/sasl2/smtpd.conf.in \
    "${pkgdir}/opt/zextras/conf/sasl2/smtpd.conf.in"
  install -D opt/zextras/conf/saslauthd.conf.in \
    "${pkgdir}/opt/zextras/conf/saslauthd.conf.in"
  install -D opt/zextras/conf/zmconfigd/postfix_content_filter.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/postfix_content_filter.cf"
  install -D opt/zextras/conf/zmconfigd/smtpd_end_of_data_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_end_of_data_restrictions.cf"
  install -D opt/zextras/conf/zmconfigd/smtpd_recipient_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_recipient_restrictions.cf"
  install -D opt/zextras/conf/zmconfigd/smtpd_relay_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_relay_restrictions.cf"
  install -D opt/zextras/conf/zmconfigd/smtpd_sender_login_maps.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_sender_login_maps.cf"
  install -D opt/zextras/conf/zmconfigd/smtpd_sender_restrictions.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd/smtpd_sender_restrictions.cf"
  install -D opt/zextras/conf/zmconfigd.cf \
    "${pkgdir}/opt/zextras/conf/zmconfigd.cf"
  install -D opt/zextras/conf/zmconfigd.log4j.properties \
    "${pkgdir}/opt/zextras/conf/zmconfigd.log4j.properties"
  install -Dm644 opt/zextras/conf/zmlogrotate \
    "${pkgdir}/opt/zextras/conf/zmlogrotate"
  install -D opt/zextras/conf/zmssl.cnf.in \
    "${pkgdir}/opt/zextras/conf/zmssl.cnf.in"
  install -D opt/zextras/contrib/zmfetchercfg \
    "${pkgdir}/opt/zextras/contrib/zmfetchercfg"
  install -D opt/zextras/db/create_database.sql \
    "${pkgdir}/opt/zextras/db/create_database.sql"
  install -D opt/zextras/db/db.sql \
    "${pkgdir}/opt/zextras/db/db.sql"

  install -Ddm755 "${pkgdir}/opt/zextras/lib/ext/com_zimbra_cert_manager"
  rsync -a opt/zextras/lib/ext/com_zimbra_cert_manager/ \
    "${pkgdir}/opt/zextras/lib/ext/com_zimbra_cert_manager"

  install -D opt/zextras/lib/junixsocket-native-2.4.0-amd64-Linux-clang-jni.nar \
    "${pkgdir}/opt/zextras/lib/junixsocket-native-2.4.0-amd64-Linux-clang-jni.nar"

  install -Dm755 opt/zextras/libexec/600.zimbra \
    "${pkgdir}/opt/zextras/libexec/600.zimbra"
  install -Dm755 opt/zextras/libexec/configrewrite \
    "${pkgdir}/opt/zextras/libexec/configrewrite"
  install -Dm755 opt/zextras/libexec/get_plat_tag.sh \
    "${pkgdir}/opt/zextras/libexec/get_plat_tag.sh"
  install -Dm755 opt/zextras/libexec/icalmig \
    "${pkgdir}/opt/zextras/libexec/icalmig"
  install -Dm755 opt/zextras/libexec/installer/bin/get_plat_tag.sh \
    "${pkgdir}/opt/zextras/libexec/installer/bin/get_plat_tag.sh"
  install -Dm755 opt/zextras/libexec/postinstall.pm \
    "${pkgdir}/opt/zextras/libexec/postinstall.pm"
  install -Dm755 opt/zextras/libexec/preinstall.pm \
    "${pkgdir}/opt/zextras/libexec/preinstall.pm"
  
  install -Ddm755 "${pkgdir}/opt/zextras/libexec/scripts"
  rsync -a opt/zextras/libexec/scripts/ \
    "${pkgdir}/opt/zextras/libexec/scripts"
  
  install -Dm755 opt/zextras/libexec/zcs \
    "${pkgdir}/opt/zextras/libexec/zcs"
  install -Dm755 opt/zextras/libexec/carbonio \
    "${pkgdir}/opt/zextras/libexec/carbonio"
  install -Dm755 opt/zextras/libexec/certbot \
    "${pkgdir}/opt/zextras/libexec/certbot"
  install -Dm755 opt/zextras/libexec/zmaltermimeconfig \
    "${pkgdir}/opt/zextras/libexec/zmaltermimeconfig"
  install -Dm755 opt/zextras/libexec/zmantispamdbinit \
    "${pkgdir}/opt/zextras/libexec/zmantispamdbinit"
  install -Dm755 opt/zextras/libexec/zmantispammycnf \
    "${pkgdir}/opt/zextras/libexec/zmantispammycnf"
  install -Dm755 opt/zextras/libexec/zmcbpolicydinit \
    "${pkgdir}/opt/zextras/libexec/zmcbpolicydinit"
  install -Dm755 opt/zextras/libexec/zmcheckexpiredcerts \
    "${pkgdir}/opt/zextras/libexec/zmcheckexpiredcerts"
  install -Dm755 opt/zextras/libexec/zmcleantmp \
    "${pkgdir}/opt/zextras/libexec/zmcleantmp"
  install -Dm755 opt/zextras/libexec/zmclientcertmgr \
    "${pkgdir}/opt/zextras/libexec/zmclientcertmgr"
  install -Dm755 opt/zextras/libexec/zmcompresslogs \
    "${pkgdir}/opt/zextras/libexec/zmcompresslogs"
  install -Dm755 opt/zextras/libexec/zmcomputequotausage \
    "${pkgdir}/opt/zextras/libexec/zmcomputequotausage"
  install -Dm755 opt/zextras/libexec/zmconfigd \
    "${pkgdir}/opt/zextras/libexec/zmconfigd"
  install -Dm755 opt/zextras/libexec/zmcpustat \
    "${pkgdir}/opt/zextras/libexec/zmcpustat"
  install -Dm755 opt/zextras/libexec/zmdailyreport \
    "${pkgdir}/opt/zextras/libexec/zmdailyreport"
  install -Dm755 opt/zextras/libexec/zmdbintegrityreport \
    "${pkgdir}/opt/zextras/libexec/zmdbintegrityreport"
  install -Dm755 opt/zextras/libexec/zmdiaglog \
    "${pkgdir}/opt/zextras/libexec/zmdiaglog"
  install -Dm755 opt/zextras/libexec/zmdkimkeyutil \
    "${pkgdir}/opt/zextras/libexec/zmdkimkeyutil"
  install -Dm755 opt/zextras/libexec/zmdomaincertmgr \
    "${pkgdir}/opt/zextras/libexec/zmdomaincertmgr"
  install -Dm755 opt/zextras/libexec/zmexplainslow \
    "${pkgdir}/opt/zextras/libexec/zmexplainslow"
  install -Dm755 opt/zextras/libexec/zmexplainsql \
    "${pkgdir}/opt/zextras/libexec/zmexplainsql"
  install -Dm755 opt/zextras/libexec/zmextractsql \
    "${pkgdir}/opt/zextras/libexec/zmextractsql"
  install -Dm755 opt/zextras/libexec/zmfixperms \
    "${pkgdir}/opt/zextras/libexec/zmfixperms"
  install -Dm755 opt/zextras/libexec/zmfixreminder \
    "${pkgdir}/opt/zextras/libexec/zmfixreminder"
  install -Dm755 opt/zextras/libexec/zmgsaupdate \
    "${pkgdir}/opt/zextras/libexec/zmgsaupdate"
  install -Dm755 opt/zextras/libexec/zmhspreport \
    "${pkgdir}/opt/zextras/libexec/zmhspreport"
  install -Dm755 opt/zextras/libexec/zminiutil \
    "${pkgdir}/opt/zextras/libexec/zminiutil"
  install -Dm755 opt/zextras/libexec/zmiostat \
    "${pkgdir}/opt/zextras/libexec/zmiostat"
  install -Dm755 opt/zextras/libexec/zmiptool \
    "${pkgdir}/opt/zextras/libexec/zmiptool"
  install -Dm755 opt/zextras/libexec/zmjavawatch \
    "${pkgdir}/opt/zextras/libexec/zmjavawatch"
  install -Dm755 opt/zextras/libexec/zmjsprecompile \
    "${pkgdir}/opt/zextras/libexec/zmjsprecompile"
  install -Dm755 opt/zextras/libexec/zmldapanon \
    "${pkgdir}/opt/zextras/libexec/zmldapanon"
  install -Dm755 opt/zextras/libexec/zmldapapplyldif \
    "${pkgdir}/opt/zextras/libexec/zmldapapplyldif"
  install -Dm755 opt/zextras/libexec/zmldapenable-mmr \
    "${pkgdir}/opt/zextras/libexec/zmldapenable-mmr"
  install -Dm755 opt/zextras/libexec/zmldapenablereplica \
    "${pkgdir}/opt/zextras/libexec/zmldapenablereplica"
  install -Dm755 opt/zextras/libexec/zmldapinit \
    "${pkgdir}/opt/zextras/libexec/zmldapinit"
  install -Dm755 opt/zextras/libexec/zmldapmmrtool \
    "${pkgdir}/opt/zextras/libexec/zmldapmmrtool"
  install -Dm755 opt/zextras/libexec/zmldapmonitordb \
    "${pkgdir}/opt/zextras/libexec/zmldapmonitordb"
  install -Dm755 opt/zextras/libexec/zmldappromote-replica-mmr \
    "${pkgdir}/opt/zextras/libexec/zmldappromote-replica-mmr"
  install -Dm755 opt/zextras/libexec/zmldapreplicatool \
    "${pkgdir}/opt/zextras/libexec/zmldapreplicatool"
  install -Dm755 opt/zextras/libexec/zmldapschema \
    "${pkgdir}/opt/zextras/libexec/zmldapschema"
  install -Dm755 opt/zextras/libexec/zmldapupdateldif \
    "${pkgdir}/opt/zextras/libexec/zmldapupdateldif"
  install -Dm755 opt/zextras/libexec/ldapattributeupdate \
    "${pkgdir}/opt/zextras/libexec/ldapattributeupdate"
  install -Dm755 opt/zextras/libexec/zmlogprocess \
    "${pkgdir}/opt/zextras/libexec/zmlogprocess"
  install -Dm755 opt/zextras/libexec/zmmailboxdmgr \
    "${pkgdir}/opt/zextras/libexec/zmmailboxdmgr"
  install -Dm755 opt/zextras/libexec/zmmailboxdmgr.unrestricted \
    "${pkgdir}/opt/zextras/libexec/zmmailboxdmgr.unrestricted"
  install -Dm755 opt/zextras/libexec/zmmsgtrace \
    "${pkgdir}/opt/zextras/libexec/zmmsgtrace"
  install -Dm755 opt/zextras/libexec/zmmtainit \
    "${pkgdir}/opt/zextras/libexec/zmmtainit"
  install -Dm755 opt/zextras/libexec/zmmtastatus \
    "${pkgdir}/opt/zextras/libexec/zmmtastatus"
  install -Dm755 opt/zextras/libexec/zmmycnf \
    "${pkgdir}/opt/zextras/libexec/zmmycnf"
  install -Dm755 opt/zextras/libexec/zmmyinit \
    "${pkgdir}/opt/zextras/libexec/zmmyinit"
  install -Dm755 opt/zextras/libexec/zmpostfixpolicyd \
    "${pkgdir}/opt/zextras/libexec/zmpostfixpolicyd"
  install -Dm755 opt/zextras/libexec/zmproxyconfgen \
    "${pkgdir}/opt/zextras/libexec/zmproxyconfgen"
  install -Dm755 opt/zextras/libexec/zmproxyconfig \
    "${pkgdir}/opt/zextras/libexec/zmproxyconfig"
  install -Dm755 opt/zextras/libexec/zmproxypurge \
    "${pkgdir}/opt/zextras/libexec/zmproxypurge"
  install -Dm755 opt/zextras/libexec/zmqaction \
    "${pkgdir}/opt/zextras/libexec/zmqaction"
  install -Dm755 opt/zextras/libexec/zmqstat \
    "${pkgdir}/opt/zextras/libexec/zmqstat"
  install -Dm755 opt/zextras/libexec/zmqueuelog \
    "${pkgdir}/opt/zextras/libexec/zmqueuelog"
  install -Dm755 opt/zextras/libexec/zmrc \
    "${pkgdir}/opt/zextras/libexec/zmrc"
  install -Dm755 opt/zextras/libexec/zmrcd \
    "${pkgdir}/opt/zextras/libexec/zmrcd"
  install -Dm755 opt/zextras/libexec/zmreplchk \
    "${pkgdir}/opt/zextras/libexec/zmreplchk"
  install -Dm755 opt/zextras/libexec/zmresetmysqlpassword \
    "${pkgdir}/opt/zextras/libexec/zmresetmysqlpassword"
  install -Dm755 opt/zextras/libexec/zmsacompile \
    "${pkgdir}/opt/zextras/libexec/zmsacompile"
  install -Dm755 opt/zextras/libexec/zmsaupdate \
    "${pkgdir}/opt/zextras/libexec/zmsaupdate"
  install -Dm755 opt/zextras/libexec/zmserverips \
    "${pkgdir}/opt/zextras/libexec/zmserverips"
  install -Dm755 opt/zextras/libexec/zmsetservername \
    "${pkgdir}/opt/zextras/libexec/zmsetservername"
  install -Dm755 opt/zextras/libexec/zmsetup.pl \
    "${pkgdir}/opt/zextras/libexec/zmsetup.pl"
  install -Dm755 opt/zextras/libexec/zmslapadd \
    "${pkgdir}/opt/zextras/libexec/zmslapadd"
  install -Dm755 opt/zextras/libexec/zmslapcat \
    "${pkgdir}/opt/zextras/libexec/zmslapcat"
  install -Dm755 opt/zextras/libexec/zmslapd \
    "${pkgdir}/opt/zextras/libexec/zmslapd"
  install -Dm755 opt/zextras/libexec/zmslapindex \
    "${pkgdir}/opt/zextras/libexec/zmslapindex"
  install -Dm755 opt/zextras/libexec/zmspamextract \
    "${pkgdir}/opt/zextras/libexec/zmspamextract"
  install -Dm755 opt/zextras/libexec/zmstat-allprocs \
    "${pkgdir}/opt/zextras/libexec/zmstat-allprocs"
  install -Dm755 opt/zextras/libexec/zmstat-cleanup \
    "${pkgdir}/opt/zextras/libexec/zmstat-cleanup"
  install -Dm755 opt/zextras/libexec/zmstat-convertd \
    "${pkgdir}/opt/zextras/libexec/zmstat-convertd"
  install -Dm755 opt/zextras/libexec/zmstat-cpu \
    "${pkgdir}/opt/zextras/libexec/zmstat-cpu"
  install -Dm755 opt/zextras/libexec/zmstat-df \
    "${pkgdir}/opt/zextras/libexec/zmstat-df"
  install -Dm755 opt/zextras/libexec/zmstat-fd \
    "${pkgdir}/opt/zextras/libexec/zmstat-fd"
  install -Dm755 opt/zextras/libexec/zmstat-io \
    "${pkgdir}/opt/zextras/libexec/zmstat-io"
  install -Dm755 opt/zextras/libexec/zmstat-ldap \
    "${pkgdir}/opt/zextras/libexec/zmstat-ldap"
  install -Dm755 opt/zextras/libexec/zmstat-mtaqueue \
    "${pkgdir}/opt/zextras/libexec/zmstat-mtaqueue"
  install -Dm755 opt/zextras/libexec/postfix-prometheus \
    "${pkgdir}/opt/zextras/libexec/postfix-prometheus"
  install -Dm755 opt/zextras/libexec/zmstat-mysql \
    "${pkgdir}/opt/zextras/libexec/zmstat-mysql"
  install -Dm755 opt/zextras/libexec/zmstat-nginx \
    "${pkgdir}/opt/zextras/libexec/zmstat-nginx"
  install -Dm755 opt/zextras/libexec/zmstat-proc \
    "${pkgdir}/opt/zextras/libexec/zmstat-proc"
  install -Dm755 opt/zextras/libexec/zmstat-vm \
    "${pkgdir}/opt/zextras/libexec/zmstat-vm"
  install -Dm755 opt/zextras/libexec/zmstatuslog \
    "${pkgdir}/opt/zextras/libexec/zmstatuslog"
  install -Dm755 opt/zextras/libexec/zmsyslogsetup \
    "${pkgdir}/opt/zextras/libexec/zmsyslogsetup"
  install -Dm755 opt/zextras/libexec/zmthreadcpu \
    "${pkgdir}/opt/zextras/libexec/zmthreadcpu"

  install -Dm755 "${srcdir}"/carbonio-bootstrap \
    "${pkgdir}/usr/bin/carbonio-bootstrap"

  install -Dm755 "${srcdir}"/mini_alue_ce \
    "${pkgdir}"/opt/zextras/.mini_alue_ce
  echo "23.5.0" > "${pkgdir}"/opt/zextras/.version
}

postrm:apt() {
  if [ "$1" = purge ]; then
    if crontab -l -u "zextras" > "/dev/null" ; then
      crontab -r -u "zextras";
    fi
  fi
}

postrm:yum() {
  if crontab -l -u "zextras" > "/dev/null" ; then
    crontab -r -u "zextras";
  fi
}

preinst:apt() {

  if [ "$1" = upgrade ]; then
    if [ x"$2" != "x" ]; then
      ca_certs_save_dir="/opt/zextras/.saveconfig/carbonio-openjdk-cacerts"
      if [ ! -d "${ca_certs_save_dir}" ]; then
        mkdir -p "${ca_certs_save_dir}"
      fi
      cacerts=$(mktemp --tmpdir="${ca_certs_save_dir}" cacerts.XXXXXX 2>/dev/null)

      cp /opt/zextras/common/etc/java/cacerts "${ca_certs_save_dir}"
    fi
  fi

  if [ "$1" = configure ]; then

    if [ "$(echo /etc/security/limits.d/*-nproc.conf)" != "/etc/security/limits.d/*-nproc.conf" ]; then
      echo "zextras soft nproc 278528" >/etc/security/limits.d/10-zextras.conf
      echo "zextras hard nproc 278528" >>/etc/security/limits.d/10-zextras.conf
      echo "postfix soft nproc 278528" >>/etc/security/limits.d/10-zextras.conf
      echo "postfix hard nproc 278528" >>/etc/security/limits.d/10-zextras.conf
      echo "root soft nproc 278528" >>/etc/security/limits.d/10-zextras.conf
      echo "root hard nproc 278528" >>/etc/security/limits.d/10-zextras.conf
    fi
    if [ -f "/etc/security/limits.conf" ]; then
      limitstmp=$(mktemp -t limitstmp.XXXXXX 2>/dev/null) || {
        echo "Failed to create tmpfile"
        exit 1
      }
      grep -E -v -e '^zextras.*nofile' /etc/security/limits.conf >$limitstmp
      echo "zextras soft nofile 524288" >>$limitstmp
      echo "zextras hard nofile 524288" >>$limitstmp
      mv -f $limitstmp /etc/security/limits.conf
      chmod 640 /etc/security/limits.conf
    else
      echo "zextras soft nofile 524288" >/etc/security/limits.conf
      echo "zextras hard nofile 524288" >>/etc/security/limits.conf
      chmod 640 /etc/security/limits.conf
    fi
  fi
}

preinst:yum() {
  if [ "$1" -ge "2" ]; then
    mkdir -p /opt/zextras/.saveconfig/carbonio-openjdk-cacerts
    cacerts=`mktemp --tmpdir=/opt/zextras/.saveconfig/carbonio-openjdk-cacerts cacerts.XXXXXX`
    cp /opt/zextras/common/etc/java/cacerts $cacerts
  fi

  if [ "$(echo /etc/security/limits.d/*-nproc.conf)" != "/etc/security/limits.d/*-nproc.conf" ]; then
    echo "zextras soft nproc 278528" >/etc/security/limits.d/10-zextras.conf
    echo "zextras hard nproc 278528" >>/etc/security/limits.d/10-zextras.conf
    echo "postfix soft nproc 278528" >>/etc/security/limits.d/10-zextras.conf
    echo "postfix hard nproc 278528" >>/etc/security/limits.d/10-zextras.conf
    echo "root soft nproc 278528" >>/etc/security/limits.d/10-zextras.conf
    echo "root hard nproc 278528" >>/etc/security/limits.d/10-zextras.conf
  fi
  if [ -f "/etc/security/limits.conf" ]; then
    limitstmp=$(mktemp -t limitstmp.XXXXXX 2>/dev/null) || {
      echo "Failed to create tmpfile"
      exit 1
    }
    grep -E -v -e '^zextras.*nofile' /etc/security/limits.conf >$limitstmp
    echo "zextras soft nofile 524288" >>$limitstmp
    echo "zextras hard nofile 524288" >>$limitstmp
    mv -f $limitstmp /etc/security/limits.conf
    chmod 640 /etc/security/limits.conf
  else
    echo "zextras soft nofile 524288" >/etc/security/limits.conf
    echo "zextras hard nofile 524288" >>/etc/security/limits.conf
    chmod 640 /etc/security/limits.conf
  fi
}

postinst:apt() {
  if [ "$1" = "configure" ]; then
    # creating zextras group if it isn't already there
    if ! getent group zextras >/dev/null; then
      addgroup --system --force-badname --quiet zextras
    fi

    # creating zextras user if it isn't already there
    if ! getent passwd zextras >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup zextras \
        --home /opt/zextras \
        --shell /bin/bash \
        zextras
      usermod -c "zextras user" zextras
    fi
  
    # creating postfix and postdrop groups if aren't already there
    if ! getent group postdrop >/dev/null; then
      addgroup --system --force-badname --quiet postdrop
    fi
    if ! getent group postfix >/dev/null; then
      addgroup --system --force-badname --quiet postfix
    fi

    # creating postfix user if it isn't already there
    if ! getent passwd postfix >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup postfix \
        --home /opt/zextras/postfix \
        postfix
      usermod -c "postfix user" postfix
    fi
    usermod -a -G postfix,tty zextras
  fi

  H=$(hostname --fqdn)
  I=$(hostname -i)

  chown zextras:zextras /opt/zextras/common/etc/java/cacerts
  chmod 644 /opt/zextras/common/etc/java/cacerts

  mailboxd_truststore_password=$(su - zextras -c "zmlocalconfig -s -m nokey mailboxd_truststore_password")
  if [ "$2" != "" ]; then
    if [ -x /opt/zextras/bin/zmcertmgr ]; then
      if [ $mailboxd_truststore_password != "changeit" ]; then
	      su - zextras -c "/opt/zextras/common/bin/keytool -storepasswd -keystore /opt/zextras/common/etc/java/cacerts -storepass changeit -new $mailboxd_truststore_password"
      fi
      for dir in /opt/zextras/.saveconfig/carbonio-openjdk-cacerts/*; do
          if [ -d "$dir" ]; then
             chown zextras:zextras $dir/cacerts.*
             chmod 644 $dir/cacerts.*
             for cert in `/opt/zextras/common/bin/keytool -list -keystore $dir/cacerts.*  -storepass $mailboxd_truststore_password | grep trustedCertEntry | grep -v 'openjdk-cacerts/build/ubuntu'| grep -v 'tmp/rhel'| grep -Eo "^[^,]*"`;do
                /opt/zextras/common/bin/keytool -exportcert -keystore $dir/cacerts.* -storepass $mailboxd_truststore_password -alias $cert -file $dir/${cert}.crt
                chown zextras:zextras $dir/${cert}.crt
                su - zextras -c "/opt/zextras/bin/zmcertmgr addcacert $dir/${cert}.crt"
             done
          fi
     done
    fi
  fi

  if [ -d "/opt/zextras/common/certbot/etc/letsencrypt" ]; then
    chown -R zextras:zextras /opt/zextras/common/certbot/etc/letsencrypt
  fi

  if [ ! -d "/opt/zextras/common/conf" ]; then
    mkdir -p /opt/zextras/common/conf
    chown -R zextras:zextras /opt/zextras/common/conf
  fi

  if [ ! -d "/opt/zextras/conf/ca" ]; then
    mkdir -p /opt/zextras/conf/ca
    chown -R zextras:zextras /opt/zextras/conf/ca
  fi

  if [ -f "/opt/zextras/conf/ca/ca.pem" ]; then
    ln -f -s ca.pem /opt/zextras/conf/ca/$(openssl x509 -hash -noout -in /opt/zextras/conf/ca/ca.pem).0
  fi

  sed -i -e '/^::1     ip6-localhost ip6-loopback localhost$/!s/::1     ip6-localhost ip6-loopback/::1     ip6-localhost ip6-loopback localhost/' /etc/hosts
  sed -i -e 's/# session    required   pam_limits.so/session    required   pam_limits.so/' /etc/pam.d/su
  pamtmp=$(mktemp -t zpamtmp.XXXXXX 2>/dev/null) || {
    echo "Failed to create tmpfile"
    exit 1
  }
  grep -E -v -e '^session[[:space:]]+required[[:space:]]+pam_limits.so' /etc/pam.d/common-session >$pamtmp
  echo "session	required	pam_limits.so" >>$pamtmp
  mv -f $pamtmp /etc/pam.d/common-session
  chmod 640 /etc/pam.d/common-session
  limitstmp=$(mktemp -t zlimtmp.XXXXXX 2>/dev/null) || {
    echo "Failed to create tmpfile"
    exit 1
  }
  grep -E -v -e '^root.*nofile' /etc/security/limits.conf >$limitstmp
  echo "root soft nofile 524288" >>$limitstmp
  echo "root hard nofile 524288" >>$limitstmp
  mv -f $limitstmp /etc/security/limits.conf
  chmod 640 /etc/security/limits.conf
  chown -R root:root /opt/zextras/common/lib/perl5/Zimbra

  if [ -d /etc/logrotate.d ]; then
    cp -f /opt/zextras/conf/zmlogrotate /etc/logrotate.d/carbonio
  fi

  cp -f /opt/zextras/libexec/carbonio /etc/init.d/carbonio
  chmod 755 /etc/init.d/carbonio
  if [ -x /usr/sbin/update-rc.d ]; then
    update-rc.d -f carbonio remove
    update-rc.d carbonio start 99 3 5 . stop 01 0 1 6 .
  else
    rm -f /etc/rc*.d/S99carbonio
    rm -f /etc/rc*.d/S89carbonio
    rm -f /etc/rc*.d/K01carbonio

    if [ -d /etc/rc0.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc0.d/S89carbonio
      ln -s /etc/init.d/carbonio /etc/rc0.d/K01carbonio
    fi
    if [ -d /etc/rc1.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc1.d/K01carbonio
    fi
    if [ -d /etc/rc2.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc2.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc2.d/K01carbonio
    fi
    if [ -d /etc/rc3.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc3.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc3.d/K01carbonio
    fi
    if [ -d /etc/rc4.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc4.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc4.d/K01carbonio
    fi
    if [ -d /etc/rc5.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc5.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc5.d/K01carbonio
    fi
    if [ -d /etc/rc6.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc6.d/S89carbonio
      ln -s /etc/init.d/carbonio /etc/rc6.d/K01carbonio
    fi

  fi

  mkdir -p /opt/zextras/backup
  chown zextras:zextras /opt/zextras/backup
  mkdir -p /opt/zextras/log
  chown zextras:zextras /opt/zextras/log
  mkdir -p /opt/zextras/ssl
  chown zextras:zextras /opt/zextras/ssl
  mkdir -p /opt/zextras/.ssh
  chown zextras:zextras /opt/zextras/.ssh
  mkdir -p /opt/zextras/zmstat
  chown zextras:zextras /opt/zextras/zmstat

  grep -E -q '^%zextras[[:space:]]' /etc/sudoers
  if [ $? = 0 ]; then
    sudotmp=$(mktemp -t zsudoers.XXXXXX 2>/dev/null) || {
      echo "Failed to create tmpfile"
      exit 1
    }
    SUDOMODE=$(perl -e 'my $mode=(stat("/etc/sudoers"))[2];if ($mode == "0000"){ $mode=33056 };printf("%04o\n",$mode & 07777);')
    grep -E -v -e '^%zextras[[:space:]]' /etc/sudoers >$sudotmp
    mv -f $sudotmp /etc/sudoers
    chmod $SUDOMODE /etc/sudoers
  fi

  chmod 440 /etc/sudoers.d/carbonio
  chown root:root /etc/sudoers.d/carbonio

  echo `date +%s`": INSTALLED ${pkgname}" >> /opt/zextras/.install_history

  if [ -x "/opt/zextras/libexec/zmfixperms" ]; then
    /opt/zextras/libexec/zmfixperms
  fi

}

postinst:yum() {
  # creating zextras group if it isn't already there
  if ! getent group zextras >/dev/null; then
    groupadd --system zextras >/dev/null
  fi
  # creating zextras user if it isn't already there
  if ! getent passwd zextras >/dev/null; then
    useradd --system \
      -g zextras \
      -d /opt/zextras \
      --shell /bin/bash \
      zextras >/dev/null
    usermod -c "zextras user" zextras
  fi

  # creating postfix and postdrop groups if aren't already there
  if ! getent group postdrop >/dev/null; then
    groupadd --system postdrop >/dev/null
  fi
  if ! getent group postfix >/dev/null; then
    groupadd --system postfix >/dev/null
  fi

  # creating postfix user if it isn't already there
  if ! getent passwd postfix >/dev/null; then
    useradd --system \
      -g postfix \
      -d /opt/zextras/postfix \
      postfix
    usermod -c "postfix user" postfix
  fi
  usermod -a -G postfix,tty zextras

  # creating postfix user if it isn't already there
  if ! getent passwd syslog >/dev/null; then
    useradd --system \
      -g adm \
      syslog
    usermod -c "syslog user" syslog
  fi

  H=$(hostname --fqdn)
  I=$(hostname -i)

  if [ -d "/opt/zextras/common/certbot/etc/letsencrypt" ]; then
    chown -R zextras:zextras /opt/zextras/common/certbot/etc/letsencrypt
  fi

  if [ ! -d "/opt/zextras/common/conf" ]; then
    mkdir -p /opt/zextras/common/conf
    chown -R zextras:zextras /opt/zextras/common/conf
  fi

  if [ ! -d "/opt/zextras/conf/ca" ]; then
    mkdir -p /opt/zextras/conf/ca
    chown -R zextras:zextras /opt/zextras/conf/ca
  fi

  if [ -f "/opt/zextras/conf/ca/ca.pem" ]; then
    ln -f -s ca.pem /opt/zextras/conf/ca/$(openssl x509 -hash -noout -in /opt/zextras/conf/ca/ca.pem).0
  fi

  mailboxd_truststore_password=$(/bin/su - zextras -c "zmlocalconfig -s -m nokey mailboxd_truststore_password")
  chown zextras:zextras /opt/zextras/common/etc/java/cacerts
  chmod 644 /opt/zextras/common/etc/java/cacerts

  if [ "$1" -ge "2" ]; then
    if [ -x /opt/zextras/bin/zmcertmgr ]; then
      # Run as zextras, extract CA to /opt/zextras/conf/ca
      su - zextras -c '/opt/zextras/bin/zmcertmgr createca'
      # Run as zextras, update OpenJDK cacerts file with the CA stored in LDAP
      su - zextras -c '/opt/zextras/bin/zmcertmgr deployca --localonly'
      if [ $mailboxd_truststore_password != "changeit" ]; then
        su - zextras -c "/opt/zextras/common/bin/keytool -storepasswd -keystore /opt/zextras/common/etc/java/cacerts -storepass changeit -new $mailboxd_truststore_password"
      fi
      for dir in /opt/zextras/.saveconfig/carbonio-openjdk-cacerts; do
        if [ -d "$dir" ]; then
          chown zextras:zextras $dir/cacerts.*
          chmod 644 $dir/cacerts.*
          for cert in $(/opt/zextras/common/bin/keytool -list -keystore $dir/cacerts.* -storepass changeit | grep trustedCertEntry | grep -v 'openjdk-cacerts/build/ubuntu' | grep -v 'tmp/rhel' | grep -v 'openjdk-cacerts/build/rhel' | grep -Eo "^[^,]*"); do
            /opt/zextras/common/bin/keytool -exportcert -keystore $dir/cacerts.* -storepass changeit -alias $cert -file $dir/${cert}.crt
            chown zextras:zextras $dir/${cert}.crt
            su - zextras -c "/opt/zextras/bin/zmcertmgr addcacert $dir/${cert}.crt"
          done
        fi
      done
    fi
  fi

  if [ -d /etc/logrotate.d ]; then
    cp -f /opt/zextras/conf/zmlogrotate /etc/logrotate.d/carbonio
  fi

  cp -f /opt/zextras/libexec/carbonio /etc/init.d/carbonio
  chmod 755 /etc/init.d/carbonio
  if [ -x /sbin/chkconfig ]; then
    chkconfig --del carbonio
    chkconfig --add carbonio
    chkconfig carbonio on
  else
    rm -f /etc/rc*.d/S99carbonio
    rm -f /etc/rc*.d/S89carbonio
    rm -f /etc/rc*.d/K01carbonio

    if [ -d /etc/rc0.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc0.d/S89carbonio
      ln -s /etc/init.d/carbonio /etc/rc0.d/K01carbonio
    fi
    if [ -d /etc/rc1.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc1.d/K01carbonio
    fi
    if [ -d /etc/rc2.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc2.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc2.d/K01carbonio
    fi
    if [ -d /etc/rc3.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc3.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc3.d/K01carbonio
    fi
    if [ -d /etc/rc4.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc4.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc4.d/K01carbonio
    fi
    if [ -d /etc/rc5.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc5.d/S99carbonio
      ln -s /etc/init.d/carbonio /etc/rc5.d/K01carbonio
    fi
    if [ -d /etc/rc6.d ]; then
      ln -s /etc/init.d/carbonio /etc/rc6.d/S89carbonio
      ln -s /etc/init.d/carbonio /etc/rc6.d/K01carbonio
    fi

  fi

  mkdir -p /opt/zextras/backup
  chown zextras:zextras /opt/zextras/backup
  mkdir -p /opt/zextras/log
  chown zextras:zextras /opt/zextras/log
  mkdir -p /opt/zextras/ssl
  chown zextras:zextras /opt/zextras/ssl
  mkdir -p /opt/zextras/.ssh
  chown zextras:zextras /opt/zextras/.ssh
  mkdir -p /opt/zextras/zmstat
  chown zextras:zextras /opt/zextras/zmstat

  grep -E -q '^%zextras[[:space:]]' /etc/sudoers
  if [ $? = 0 ]; then
    sudotmp=$(mktemp -t zsudoers.XXXXXX 2>/dev/null) || {
      echo "Failed to create tmpfile"
      exit 1
    }
    SUDOMODE=$(perl -e 'my $mode=(stat("/etc/sudoers"))[2];if ($mode == "0000"){ $mode=33056 };printf("%04o\n",$mode & 07777);')
    grep -E -v -e '^%zextras[[:space:]]' /etc/sudoers >$sudotmp
    mv -f $sudotmp /etc/sudoers
    chmod $SUDOMODE /etc/sudoers
  fi

  chmod 440 /etc/sudoers.d/carbonio
  chown root:root /etc/sudoers.d/carbonio

  echo `date +%s`": INSTALLED ${pkgname}" >> /opt/zextras/.install_history

  if [ -x "/opt/zextras/libexec/zmfixperms" ]; then
    /opt/zextras/libexec/zmfixperms
  fi
}
